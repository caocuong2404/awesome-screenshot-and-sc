Diigo={Text:{},Doodle:{},UndoRedo:{},Data:{},FPT:{},$:function(t){return document.getElementById(t)}},function(t){var i,e={parsePathData:function(t){if(!t)return[];var i=t,e=["m","M","l","L","v","V","h","H","z","Z","c","C","q","Q","t","T","s","S","a","A"];i=i.replace(new RegExp(" ","g"),",");for(var o=0;o<e.length;o++)i=i.replace(new RegExp(e[o],"g"),"|"+e[o]);var s=i.split("|"),n=[],a=0,h=0;for(o=1;o<s.length;o++){var r=s[o],_=r.charAt(0),l=(r=(r=(r=(r=r.slice(1)).replace(new RegExp(",-","g"),"-")).replace(new RegExp("-","g"),",-")).replace(new RegExp("e,-","g"),"e-")).split(",");0<l.length&&""===l[0]&&l.shift();for(var d=0;d<l.length;d++)l[d]=parseFloat(l[d]);for(;0<l.length&&!isNaN(l[0]);){var c,u,f,p,g,x,y,m,v,w,b=null,D=[];switch(_){case"l":a+=l.shift(),h+=l.shift(),b="L",D.push(a,h);break;case"L":a=l.shift(),h=l.shift(),D.push(a,h);break;case"m":var T=l.shift(),M=l.shift();if(a+=T,h+=M,b="M",2<n.length&&"z"===n[n.length-1].command)for(var C=n.length-2;0<=C;C--)if("M"===n[C].command){a=n[C].points[0]+T,h=n[C].points[1]+M;break}D.push(a,h),_="l";break;case"M":a=l.shift(),h=l.shift(),b="M",D.push(a,h),_="L";break;case"h":a+=l.shift(),b="L",D.push(a,h);break;case"H":a=l.shift(),b="L",D.push(a,h);break;case"v":h+=l.shift(),b="L",D.push(a,h);break;case"V":h=l.shift(),b="L",D.push(a,h);break;case"C":D.push(l.shift(),l.shift(),l.shift(),l.shift()),a=l.shift(),h=l.shift(),D.push(a,h);break;case"c":D.push(a+l.shift(),h+l.shift(),a+l.shift(),h+l.shift()),a+=l.shift(),h+=l.shift(),b="C",D.push(a,h);break;case"S":u=a,f=h,"C"===(c=n[n.length-1]).command&&(u=a+(a-c.points[2]),f=h+(h-c.points[3])),D.push(u,f,l.shift(),l.shift()),a=l.shift(),h=l.shift(),b="C",D.push(a,h);break;case"s":u=a,f=h,"C"===(c=n[n.length-1]).command&&(u=a+(a-c.points[2]),f=h+(h-c.points[3])),D.push(u,f,a+l.shift(),h+l.shift()),a+=l.shift(),h+=l.shift(),b="C",D.push(a,h);break;case"Q":D.push(l.shift(),l.shift()),a=l.shift(),h=l.shift(),D.push(a,h);break;case"q":D.push(a+l.shift(),h+l.shift()),a+=l.shift(),h+=l.shift(),b="Q",D.push(a,h);break;case"T":u=a,f=h,"Q"===(c=n[n.length-1]).command&&(u=a+(a-c.points[0]),f=h+(h-c.points[1])),a=l.shift(),h=l.shift(),b="Q",D.push(u,f,a,h);break;case"t":u=a,f=h,"Q"===(c=n[n.length-1]).command&&(u=a+(a-c.points[0]),f=h+(h-c.points[1])),a+=l.shift(),h+=l.shift(),b="Q",D.push(u,f,a,h);break;case"A":p=l.shift(),g=l.shift(),x=l.shift(),y=l.shift(),m=l.shift(),v=a,w=h,a=l.shift(),h=l.shift(),b="A",D=this.convertEndpointToCenterParameterization(v,w,a,h,y,m,p,g,x);break;case"a":p=l.shift(),g=l.shift(),x=l.shift(),y=l.shift(),m=l.shift(),v=a,w=h,a+=l.shift(),h+=l.shift(),b="A",D=this.convertEndpointToCenterParameterization(v,w,a,h,y,m,p,g,x)}n.push({command:b||_,points:D})}"z"!==_&&"Z"!==_||n.push({command:"z",points:[]})}return n},convertEndpointToCenterParameterization:function(t,i,e,o,s,n,a,h,r){var _=r*(Math.PI/180),l=Math.cos(_)*(t-e)/2+Math.sin(_)*(i-o)/2,d=-1*Math.sin(_)*(t-e)/2+Math.cos(_)*(i-o)/2,c=l*l/(a*a)+d*d/(h*h);1<c&&(a*=Math.sqrt(c),h*=Math.sqrt(c));var u=Math.sqrt((a*a*(h*h)-a*a*(d*d)-h*h*(l*l))/(a*a*(d*d)+h*h*(l*l)));function f(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function p(t,i){return(t[0]*i[0]+t[1]*i[1])/(f(t)*f(i))}function g(t,i){return(t[0]*i[1]<t[1]*i[0]?-1:1)*Math.acos(p(t,i))}s===n&&(u*=-1),isNaN(u)&&(u=0);var x=u*a*d/h,y=u*-h*l/a,m=(t+e)/2+Math.cos(_)*x-Math.sin(_)*y,v=(i+o)/2+Math.sin(_)*x+Math.cos(_)*y,w=g([1,0],[(l-x)/a,(d-y)/h]),b=[(l-x)/a,(d-y)/h],D=[(-1*l-x)/a,(-1*d-y)/h],T=g(b,D);return p(b,D)<=-1&&(T=Math.PI),1<=p(b,D)&&(T=0),0===n&&0<T&&(T-=2*Math.PI),1===n&&T<0&&(T+=2*Math.PI),[m,v,a,h,w,T,_,n]}},o=navigator.userAgent.toLowerCase();(i=o.match(/msie ([\d.]+)/))?t.ie=i[1]:(i=o.match(/firefox\/([\d.]+)/))?t.firefox=i[1]:(i=o.match(/chrome\/([\d.]+)/))?t.chrome=i[1]:(i=o.match(/opera.([\d.]+)/))?t.opera=i[1]:(i=o.match(/version\/([\d.]+).*safari/))&&(t.safari=i[1]),(i=o.match(/trident\/.*rv:([\d.]+)/))&&(t.ie=i[1]),(i=o.match(/mac os x (\d+)[\._](\d+)/))?t.macOS=i[1]+"."+i[2]:t.winOS=!0,(i=o.match(/ipad;.+version\/(\d+\.\d+)/))&&(t.iPad=i[1]),(i=o.match(/android/))&&(t.android=!0),t.touchable=!1;var s=window.navigator.msPointerEnabled;t.touchEventType={start:s?"10.0"===t.ie?"MSPointerDown":"pointerdown":"mousedown",move:s?"10.0"===t.ie?"MSPointerMove":"pointermove":"mousemove",end:s?"10.0"===t.ie?"MSPointerUp":"pointerup":"mouseup"},t.extend=function(i,e){for(var o in e){if(null!=i[o])throw t.log(o),"extend error!";i[o]=e[o]}};var n=new Image;n.src="images/cross.png",t.extend(t,{parseSVGPath:function(t){return e.parsePathData(t)},__debug__:!0,log:function(t,i,e){this.__debug__&&jQuery.log.apply(this,arguments)},__IMAGE_CANVAS__:null,__IMAGE_CTX__:null,_getHelperImageCanvas:function(){return null===this.__IMAGE_CANVAS__&&(this.__IMAGE_CANVAS__=document.createElement("canvas"),this.__IMAGE_CTX__=this.__IMAGE_CANVAS__.getContext("2d")),this.__IMAGE_CANVAS__},getListCursor:function(i){t._getHelperImageCanvas();var e=this.__IMAGE_CANVAS__,o=this.__IMAGE_CTX__;return e.width=e.height=32,o.drawImage(n,0,18),o.font="bold 14px Arial",o.fillStyle="#39abed",o.strokeStyle="white",o.textAlign="center",o.textBaseline="middle",o.save(),o.lineWidth=2,o.shadowBlur=4,o.shadowColor="rgba(0,0,0,0.3)",o.shadowOffsetX=1,o.shadowOffsetY=2,o.strokeText(i,20,10),o.restore(),o.fillText(i,20,10),'url("'+e.toDataURL()+'") 6 25, auto'},image2url:function(i){t._getHelperImageCanvas();var e=this.__IMAGE_CANVAS__,o=this.__IMAGE_CTX__;e.width=i.naturalWidth,e.height=i.naturalHeight,o.drawImage(i,0,0);var s=e.toDataURL();return e.width=e.height=0,s},canvas2image:function(i,e,o,s,n,a){t._getHelperImageCanvas();var h=i;"number"==typeof e?(this.__IMAGE_CANVAS__.width=s,this.__IMAGE_CANVAS__.height=n,this.__IMAGE_CTX__.drawImage(i,e,o,s,n,0,0,s,n),h=this.__IMAGE_CANVAS__):"function"==typeof e&&(a=e);var r=new Image;return"function"==typeof a&&(r.onload=function(){a()}),r.src=h.toDataURL(),r},image2scale:function(i,e,o){var s=t._getHelperImageCanvas(),n=this.__IMAGE_CTX__,a=i.width,h=i.height,r=Math.floor(a*e),_=Math.floor(h*e);s.width=r,s.height=_,n.drawImage(i,0,0,r,_);var l=new Image;return"function"==typeof o&&(l.onload=o),l.src=s.toDataURL(),l},genPoints:function(t){for(var i=[],e=0;e<t;e++)i.push({x:0,y:0});return i},_getEventPoint:function(t){var i=0,e=0;if(void 0!==t.pageX)i=t.pageX,e=t.pageY;else{if(void 0===t.clientX)throw"no x,y in event(_getEventPoint)";i=t.clientX,e=t.clientY}return{x:i,y:e}},getDomPosition:function(t){for(var i=0,e=0;null!=t;)i+=t.offsetLeft,e+=t.offsetTop,t=t.offsetParent;return{left:i,top:e}},addEvent:function(i,e,o){"string"==typeof i&&(i=t(i)),window.addEventListener?i.addEventListener(e,o):i.attachEvent("on"+e,o)},delEvent:function(i,e,o){"string"==typeof i&&(i=t(i)),window.removeEventListener?i.removeEventListener(e,o):i.detachEvent("on"+e,o)},addGesture:function(i,e,o,s,n,a){function h(){o()}function r(t,i,e){var o=0;return u||c||((d=t/f.scale)<.97|1.03<d?c=!0:(8<Math.abs(i)||8<Math.abs(e))&&(u=!0)),c?(d=t/f.scale)<.88|1.12<d&&(s(t),o=1):u&&(10<Math.abs(i)||10<Math.abs(e))&&(n(i,e),o=2),o}function _(i){u=c=!1,f.x=0,f.y=0,t.stopEvent(i)}function l(){g.ie_timeout=null,e(g.ie_event)}"string"==typeof i&&(i=document.getElementById(i)),"function"!=typeof a&&(a=function(){});var d,c=!1,u=!1,f={scale:0,x:0,y:0},p=1,g={ie_timeout:null,ie_event:null};if(t.ie){var x=new MSGesture,y=[];x.target=i,t.addEvent(i,"MSGestureStart",(function(i){p=i.scale,f.scale=i.scale,f.x=i.translationX,f.y=i.translationY,h(),t.stopEvent(i)})),t.addEvent(i,"MSGestureChange",(function(i){f.x+=i.translationX,f.y+=i.translationY;var e=r(p*=i.scale,f.x,f.y);1===e?f.scale=p:2===e&&(f.x=0,f.y=0),t.stopEvent(i)})),t.addEvent(i,"MSGestureEnd",_),t.addEvent(i,t.touchEventType.start,(function(t){var i=y.indexOf(t.pointerId);if(!(0<=i))if(0===y.length)y.push(t.pointerId),g.ie_event=t,g.ie_timeout=window.setTimeout(l,80);else if(1===y.length)for(null!==g.ie_timeout&&(window.clearTimeout(g.ie_timeout),g.ie_timeout=null),y.push(t.pointerId),i=0;i<y.length;i++)x.addPointer(y[i])})),t.addEvent(i,t.touchEventType.end,(function(t){1===y.length&&(null!==g.ie_timeout&&(window.clearTimeout(g.ie_timeout),g.ie_timeout=null,e(g.ie_event)),a(t)),y.length=0}))}else{var m=!1;t.addEvent(i,t.touchEventType.start,(function(t){1===t.touches.length&&(m=!1,e(t))})),t.addEvent(i,"gesturestart",(function(i){m=!0,f.scale=i.scale,f.x=i.pageX,f.y=i.pageY,h(),t.stopEvent(i)})),t.addEvent(i,"gesturechange",(function(i){var e=r(i.scale,i.pageX-f.x,i.pageY-f.y);1===e?f.scale=i.scale:2===e&&(f.x=i.pageX,f.y=i.pageY),t.stopEvent(i)})),t.addEvent(i,"gestureend",_),t.addEvent(i,t.touchEventType.end,(function(t){!1===m&&a(t)}))}},addMouseEvent:function(i,e,o){var s={};if(t.touchable&&0<=["mousedown","mousemove","mouseup"].indexOf(e)){function n(t){t.touches&&1<t.touches.length||t.changedTouches&&1<t.changedTouches.length||o.apply(this,arguments)}var a="mousedown"===e?t.touchEventType.start:"mousemove"===e?t.touchEventType.move:t.touchEventType.end;t.addEvent(i,a,n),s[a]=n}else t.addEvent(i,e,o),s[e]=o;return s},delMouseEvent:function(i,e){for(var o in e)t.delEvent(i,o,e[o])},createDelegate:function(t,i){return function(){i.apply(t,arguments)}},stopEvent:function(t){null!=t&&(t.preventDefault?t.preventDefault():t.returnValue=!1,t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,t.preventManipulation&&t.preventManipulation())},addWheelEvent:function(i,e){"string"==typeof i&&(i=t(i)),window.addEventListener?t.firefox?i.addEventListener("DOMMouseScroll",e):i.addEventListener("mousewheel",e):i.attachEvent("onmousewheel",e)},inherit:function(t,i){if(void 0===t||void 0===i)throw"inherit error!";for(var e in i.prototype)void 0===t.prototype[e]&&(t.prototype[e]=i.prototype[e]);if(t.__base_objects__=new Array,t.__base_objects__.push(i),void 0!==i.__base_objects__)for(var o=0;o<i.__base_objects__.length;o++)t.__base_objects__.push(i.__base_objects__[o]);t.prototype.base=function(i){var e=null,o=void 0;return void 0===this.__inherit_base_deep__?this.__inherit_base_deep__=0:this.__inherit_base_deep__++,e=t.__base_objects__[this.__inherit_base_deep__],o=void 0===i||null==i?e.call(this):i instanceof Array==1?e.apply(this,i):e.apply(this,[].slice.call(arguments)),this.__inherit_base_deep__--,o},t.prototype.callBase=function(i,e){var o=void 0;void 0===this.__inherit_deep__?this.__inherit_deep__=0:this.__inherit_deep__++;var s=t.__base_objects__[this.__inherit_deep__].prototype[i];if("function"!=typeof s)throw"There is no method:"+i+" in baseClass";return o=null==e?s.call(this):e instanceof Array==1?s.apply(this,e):s.apply(this,[].slice.call(arguments,1)),this.__inherit_deep__--,o}},__FONT_INFO_TABLE__:{},getFontInfo:function(t){var i=this.__FONT_INFO_TABLE__[t];return null==i&&(i=this.__FONT_INFO_TABLE__[t]=this._calcFontInfo(t)),i},_calcFontInfo:function(t){var i=document.createElement("div"),e=document.createElement("span"),o=document.createElement("span");i.style.margin="0px",i.style.padding="0px",i.style.position="relative",i.style.left="0px",i.style.top="0px",i.style.overflow="hidden",i.style.whiteSpace="nowrap",i.style.visibility="hidden",e.style.font=t,e.style.margin="0px",e.style.padding="0px",e.style.verticalAlign="baseline",e.style.whiteSpace="nowrap",o.style.font=t.replace(/\d+px/,"0px"),o.style.margin="0px",o.style.padding="0px",o.style.verticalAlign="baseline",e.style.whiteSpace="nowrap";var s="@白羊座小葛 04-02.I Love Diigo.南京大学";e.innerHTML=s,o.innerHTML=s,i.appendChild(o),i.appendChild(e),document.body.appendChild(i);var n=i.offsetHeight,a=e.offsetHeight+e.offsetTop-o.offsetTop+e.offsetTop;return document.body.removeChild(i),{height:n,baseline:o.offsetTop,baseline_offset:a}},getMiddlePoint:function(t,i){return{x:(t.x+i.x)/2,y:(t.y+i.y)/2}},drawBesier:function(i,e){var o=e.length;if(0!==o&&1!==o){i.beginPath();var s=null,n=e[0];i.moveTo(n.x,n.y);for(var a=0;a<o-1;a++)s=t.getMiddlePoint(e[a],e[a+1]),i.quadraticCurveTo(n.x,n.y,s.x,s.y),n=e[a+1];s=e[o-1],i.quadraticCurveTo(n.x,n.y,s.x,s.y),i.stroke(),i.closePath()}},drawLine:function(t,i,e,o,s){t.beginPath(),t.moveTo(i,e),t.lineTo(o,s),t.stroke(),t.closePath()},drawLine_w:function(i,e,o,s,n){t.drawLine(i,e,o,e+s,o+n)},drawEllipse:function(t,i,e,o,s,n){t.beginPath(),t.ellipse(i,e,o,s,0,0,2*Math.PI,0),t.closePath(),null!==n&&(t.fillStyle=n,t.fill()),t.stroke()},calcArrow_new:function(i,e,o,s,n){function a(t,i,e,o,s){var n=[0,0],a=t*Math.cos(e)-i*Math.sin(e),h=t*Math.sin(e)+i*Math.cos(e);if(o){var r=Math.sqrt(a*a+h*h);a=a/r*s,h=h/r*s,n[0]=a,n[1]=h}return n}var h=t.getPTPRange_xy(i,e,o,s),r=n,_=.52*r,l=Math.atan(_/r),d=Math.sqrt(_*_+r*r),c=a(o-i,s-e,l,!0,d),u=a(o-i,s-e,-l,!0,d),f=a(o-i,s-e,l,!0,d+5),p=a(o-i,s-e,-l,!0,d+5),g=Math.floor(o-c[0]),x=Math.floor(s-c[1]),y=Math.floor(o-u[0]),m=Math.floor(s-u[1]),v=g+(y-g)/4,w=x+(m-x)/4,b=g+(y-g)/4*3,D=x+(m-x)/4*3,T=Math.floor(o-f[0]),M=Math.floor(s-f[1]),C=Math.floor(o-p[0]),E=Math.floor(s-p[1]),P=r/h,R=Math.floor(o-(o-i)*P);return y5=Math.floor(s-(s-e)*P),{ax:T,ay:M,bx:C,by:E,cx:R,cy:y5,dx:o,dy:s,ex:v,ey:w,fx:b,fy:D}},calcArrow:function(i,e,o,s,n){function a(t,i,e,o,s){var n=[0,0],a=t*Math.cos(e)-i*Math.sin(e),h=t*Math.sin(e)+i*Math.cos(e);if(o){var r=Math.sqrt(a*a+h*h);a=a/r*s,h=h/r*s,n[0]=a,n[1]=h}return n}var h=t.getPTPRange_xy(i,e,o,s),r=n,_=.42*r,l=Math.atan(_/r),d=Math.sqrt(_*_+r*r),c=a(o-i,s-e,l,!0,d),u=a(o-i,s-e,-l,!0,d),f=Math.floor(o-c[0]),p=Math.floor(s-c[1]),g=Math.floor(o-u[0]),x=Math.floor(s-u[1]),y=r/h,m=Math.floor(o-(o-i)*y);return y5=Math.floor(s-(s-e)*y),{ax:f,ay:p,bx:g,by:x,cx:m,cy:y5,dx:o,dy:s}},drawArrow:function(i,e,o,s,n){var a=t.calcArrow(e,o,s,n);t.drawLine(i,s,n,a.ax,a.ay),t.drawLine(i,s,n,a.bx,a.by)},clearContext:function(t){t.clearRect(t.canvas.width,t.canvas.height)},copyArray:function(t){for(var i=[],e=0;e<t.length;e++)i.push(t[e]);return i},setArray:function(t,i){for(var e=0;e<t.length;e++)t[e]=i[e]},copyPoints:function(t){var i=[];if(0===t.length)return i;for(var e=void 0!==t[0].p,o=0;o<t.length;o++){var s={x:t[o].x,y:t[o].y};e&&(s.p=t[o].p),i.push(s)}return i},setPoints:function(t,i){if(0!==t.length&&t.length===i.length)for(var e=0;e<t.length;e++)t[e].x=i[e].x,t[e].y=i[e].y},getPTPRange:function(t,i){return Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2))},getPTPRange_xy:function(t,i,e,o){return Math.sqrt(Math.pow(t-e,2)+Math.pow(i-o,2))},color2int:function(t){return t[0]<<16|t[1]<<8|t[2]},int2color:function(t){var i=(16711680&t).toString(16),e=(65280&t).toString(16),o=(255&t).toString(16);return"#"+(1===i.length?"0":"")+i+(1===e.length?"0":"")+e+(1===o.length?"0":"")+o},rgba2str:function(t,i,e,o){return void 0!==o?"rgba("+t+","+i+","+e+","+o+")":"#"+(t<10?"0":"")+t.toString(16).toUpperCase()+(i<10?"0":"")+i.toString(16).toUpperCase()+(e<10?"0":"")+e.toString(16).toUpperCase()},str2rgba:function(t){var i,e=0,o=0,s=0,n=1;return/^#[0-9a-f]{3}$/i.test(t)?(e=parseInt(t.substr(1,1)+t.substr(1,1),16),o=parseInt(t.substr(2,1)+t.substr(2,1),16),s=parseInt(t.substr(3,1)+t.substr(3,1),16),n=1):/^#[0-9a-f]{6}$/i.test(t)?(e=parseInt(t.substr(1,2),16),o=parseInt(t.substr(3,2),16),s=parseInt(t.substr(5,2),16),n=1):null!=(i=t.match(/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i))&&(e=parseInt(i[1]),o=parseInt(i[2]),s=parseInt(i[3]),n=1),null!=(i=t.match(/^rgba\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d(\.\d+)?)\s*\)$/i))&&(e=parseInt(i[1]),o=parseInt(i[2]),s=parseInt(i[3]),n=parseFloat(i[4])),{r:e,g:o,b:s,a:n}},is_color_blank:function(t){return"#000000"===t||"#000"===t||"blank"===t||/^rgba\(\s*0\s*,\s*0\s*,\s*0\s*,\s*0\s*\)$/i.test(t)||/^rgb\(\s*0\s*,\s*0\s*,\s*0\s*\)$/i.test(t)},setLineDash:function(t,i){void 0!==t.setLineDash?t.setLineDash(i):void 0!==t.mozDash&&(t.mozDash=i)},getCanvasBlob:function(t,i,e){if(t.toBlob)t.toBlob((function(t){e(t)}),i);else{for(var o=t.toDataURL(i),s=atob(o.substring("data:"+i+";base64,".length)),n=new Uint8Array(s.length),a=0,h=s.length;a<h;++a)n[a]=s.charCodeAt(a);e(new Blob([n.buffer],{type:"image/png"}))}},dataUrl2Blob:function(t){for(var i=atob(t.substring("data:image/png;base64,".length)),e=new Uint8Array(i.length),o=0,s=i.length;o<s;++o)e[o]=i.charCodeAt(o);return new Blob([e.buffer],{type:"image/png"})}})}(Diigo.$),function(t){t.fn.extend({addMouseEvent:function(t,i,o){function s(t){e=t.originalEvent,e.touches&&1<e.touches.length||e.changedTouches&&1<e.changedTouches.length||n.apply(this,arguments)}var n="function"==typeof i?i:"function"==typeof o?o:function(){},a="mousedown"===t?Diigo.$.touchEventType.start:"mousemove"===t?Diigo.$.touchEventType.move:Diigo.$.touchEventType.end;return Diigo.$.touchable&&0<=["mousedown","mousemove","mouseup"].indexOf(t)?"function"==typeof i?this.on(a,s):(this.on(a,i,s),this.on(t,i,(function(t){n.apply(this,arguments)}))):"function"==typeof i?this.on(t,i):this.on(t,i,o),this},addMouseDownEvent:function(t,i){return this.addMouseEvent("mousedown",t,i)},addMouseMoveEvent:function(t,i){return this.addMouseEvent("mousemove",t,i)},addMouseUpEvent:function(t,i){return this.addMouseEvent("mouseup",t,i)},addMouseTagEvent:function(t,i){var e=!0,o=Diigo.$.touchEventType.start,s=Diigo.$.touchEventType.end;function n(t){(t=t.originalEvent||t).touches&&0<t.touches.length?(h.x=t.touches[0].pageX,h.y=t.touches[0].pageY):(h.x=t.pageX,h.y=t.pageY)}function a(t){var e,o;o=(t=t.originalEvent||t).changedTouches&&0<t.changedTouches.length?(e=t.changedTouches[0].pageX,t.changedTouches[0].pageY):(e=t.pageX,t.pageY),Math.sqrt(Math.pow(h.x-e,2)+Math.pow(h.y-o,2)<20)&&i.apply(this,arguments)}"function"==typeof t&&(i=t,e=!1);var h={x:0,y:0};return Diigo.$.touchable?e?(this.on(o,t,n),this.on(s,t,a)):(this.on(o,n),this.on(s,a)):e?this.on("mousedown",t,i):this.on("mousedown",i),this}}),t.stopEvent=function(t){void 0!==t&&(t.preventDefault(),t.stopPropagation())}}(jQuery),function(t,i,e,o){i._Drawer=function(t,o){this.parent=t,this.container=t.container,this.out_container=t.out_container,this.edit_canvas=t.layer_canvas,this.doodle_canvas=t.doodle_canvas,this.textarea=t.textarea,this.textarea_out=t.textarea_out,this.$list_dialog=t.$list_dialog,this.$list_input=this.$list_dialog.find("input"),this.choose_canvas=document.createElement("canvas"),this.temp_canvas=document.createElement("canvas"),this.image_canvas=document.createElement("canvas"),this.blur_canvas=document.createElement("canvas"),this.i_ctx=this.image_canvas.getContext("2d"),this.d_ctx=this.doodle_canvas.getContext("2d"),this.e_ctx=this.edit_canvas.getContext("2d"),this.c_ctx=this.choose_canvas.getContext("2d"),this.t_ctx=this.temp_canvas.getContext("2d"),this.b_ctx=this.blur_canvas.getContext("2d"),this.dpr=window.devicePixelRatio,this.out_pos=null,this.style={brush_type:i.Type.CURVE,pen_width:4,pen_opacity:1,pen_color:"#000",dot_type:i.LineType.NORMAL,arrow_type:i.LineType.NORMAL,color:"rgba(0,0,0,1.0)",text_color:"#000000",textBackground:!1,font_size:24,font_name:"Times New Roman",svg_image:new Image,blur_radius:15},this.cur_textbox=null,this.history=new e._UndoRedoManager(this),this.zoom_scale=1,this.page={doodle_array:[]},this.edit_doodle=new i._EditDoodle(this),this.temp_doodle=null,this.has_selected_doodle=!1,this.default_cursor="url(images/pencil.png),auto",this.image_canvas.width=t.image.naturalWidth,this.image_canvas.height=t.image.naturalHeight,this.i_ctx.drawImage(t.image,0,0),this.bg_info={saved_origin:null,origin_image:null,image:this.image_canvas,x:0,y:0,width:t.image.naturalWidth,height:t.image.naturalHeight},this.__pre_mouse_enter_region__=null,this.__region_visible__=!0,this.cut_mode=!1,this.cut_doodle=null,this.__cut_undo_command__=null,this.__tmp_undo_command__=null,this.style_callback=o,this.initEvent(),this.textbox_editor=new Diigo.Text._Editor(this),this.pre_cursor_name="",this.cursor_type=1,this.d_changed=!1},i._Drawer.prototype={onChange:function(){},setCursor:function(t){jQuery(this.edit_canvas).removeClass(this.pre_cursor_name),this.edit_canvas.style.cursor=t,this.pre_cursor_name=""},setCursor_name:function(t){this.edit_canvas.style.cursor="",jQuery(this.edit_canvas).removeClass(this.pre_cursor_name).addClass(t),this.pre_cursor_name=t},blur:function(){this.focused&&(o.log("d blur"),this.focused=!1)},focus:function(){this.focused||(o.log("d focus"),o.touchable||this.caret.focus(),this.focused=!0),null!==this.cur_textbox&&this.cur_textbox.actived&&this.cur_textbox.editor.focus()},isEdited:function(){var t=this.bg_info;return 0<this.page.doodle_array.length||t.width!==t.origin_image.naturalWidth||t.height!==t.origin_image.naturalHeight||0!==t.x||0!==t.y||t.width!==t.image.width||t.height!==t.image.height},isChanged:function(){return this.isEdited()||this.d_changed},setBgInfo:function(t,i){this.bg_info.origin_image=t,this.bg_info.saved_origin=null,this.bg_info.image=this.image_canvas,this.bg_info.width=t.naturalWidth,this.bg_info.height=t.naturalHeight,this.bg_info.x=0,this.bg_info.y=0,this.zoom_scale=1,this._clear(),this._do_resize(),this.d_changed=!1;var e=this;this.out_container.style.visibility="hidden",i?window.setTimeout((function(){e._on_resize(),e.setFitScale(),e.out_container.style.visibility="visible",e.paint()}),0):window.setTimeout((function(){e._on_resize(),e.out_container.style.visibility="visible",e.paint()}),0)},setTextBackground:function(t){this.style.textBackground=t;var e=i.Type,o=this.cur_textbox||this._get_selected_shape();null===o||o.type!==e.TEXT&&o.type!==e.INNERTEXT&&o.type!==e.CALLOUT||o.setTextBackground(t)},setBgImage:function(t,i){this.bg_info.origin_image=t,this.bg_info.saved_origin=null,this.image_canvas.width=t.naturalWidth,this.image_canvas.height=t.naturalHeight,this.i_ctx.drawImage(t,0,0),this.bg_info.image=this.image_canvas,this.bg_info.width=t.naturalWidth,this.bg_info.height=t.naturalHeight,this.bg_info.x=0,this.bg_info.y=0,this.zoom_scale=1,this._clear(),this._do_resize(),this.d_changed=!1;var e=this;this.out_container.style.visibility="hidden",i?window.setTimeout((function(){e._on_resize(),e.setFitScale(),e.out_container.style.visibility="visible",e.paint()}),0):window.setTimeout((function(){e._on_resize(),e.out_container.style.visibility="visible",e.paint()}),0)},resize:function(){this.zoom_scale=1,this._resize(),this.paint()},_do_resize:function(){var t=Math.floor(this.bg_info.width*this.zoom_scale),i=Math.floor(this.bg_info.height*this.zoom_scale);this.edit_canvas.width=t,this.edit_canvas.height=i,this.doodle_canvas.width=t,this.doodle_canvas.height=i,this.choose_canvas.height=i,this.choose_canvas.width=t,this.temp_canvas.width=t,this.temp_canvas.height=i,this.blur_canvas.width=t,this.blur_canvas.height=i,this.edit_canvas.style.width=t/this.dpr+"px",this.edit_canvas.style.height=i/this.dpr+"px",this.doodle_canvas.style.width=t/this.dpr+"px",this.doodle_canvas.style.height=i/this.dpr+"px",this.choose_canvas.style.height=i/this.dpr+"px",this.choose_canvas.style.width=t/this.dpr+"px",this.temp_canvas.style.width=t/this.dpr+"px",this.temp_canvas.style.height=i/this.dpr+"px",this.blur_canvas.style.width=t/this.dpr+"px",this.blur_canvas.style.height=i/this.dpr+"px",this.container.style.width=t/this.dpr+"px",this.container.style.height=i/this.dpr+"px",this.out_container.scrollLeft=0,this.out_container.scrollTop=0},_resize:function(){this._do_resize(),this._on_resize()},_resetDoodleScale:function(){for(var t=this.page.doodle_array,i=0;i<t.length;i++)t[i].resetScale()},setScale:function(t){this.zoom_scale=t,this._resetDoodleScale(),this._resize(),this.paint()},setFitScale:function(){var t=this.out_container,i=t.offsetWidth,e=t.offsetHeight,o=this.bg_info,s=i/o.width,n=e/o.height;s<1||n<1?this.setScale(Math.min(s,n)):this.setScale(1)},setImageSize:function(t,i){null!==this.cur_textbox&&this.unactiveTextbox(),this.hideListDialog(),this.__tmp_undo_command__=new e._SizeCommand(this),this._set_image_size_redo(t,i),this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null},_set_image_size_undo:function(t,i,e){var o=this.bg_info;this.zoom_scale=1,this.image_canvas.width=t.width,this.image_canvas.height=t.height,this.i_ctx.drawImage(t,0,0),o.x=i.x,o.y=i.y,o.width=i.width,o.height=i.height,this._resize(),[].push.apply(this.page.doodle_array,e),this.paint(),this._clear_back()},_set_image_size_redo:function(t,i){this.setScale(1),this._select_nothing();var e=this.d_ctx,o=this.zoom_scale,s=this.bg_info;this.zoom_scale=1,this.d_ctx=this.b_ctx,this.blur_canvas.width=s.width,this.blur_canvas.height=s.height,this._paintDoodleLayer(),this.d_ctx=e,this.image_canvas.width=t,this.image_canvas.height=i,this.i_ctx.drawImage(this.blur_canvas,0,0,s.width,s.height,0,0,t,i),s.width=t,s.height=i,s.x=0,s.y=0,this.zoom_scale=o,this._resize(),this.page.doodle_array.length=0,this._clear_back(),this.paint(),this.setScale(o)},_get_image:function(t,i,e){var s;null!==this.cur_textbox&&this.unactiveTextbox(),this._select_nothing();var n=this.bg_info,a=this.d_ctx,h=this.zoom_scale,r=this.blur_canvas.width,_=this.blur_canvas.height;return this.zoom_scale=1,this._resetDoodleScale(),this.d_ctx=this.b_ctx,this.blur_canvas.width=n.width,this.blur_canvas.height=n.height,this.temp_canvas.width=n.width,this.temp_canvas.height=n.height,this._paintDoodleLayer(),s="url"===t?this.blur_canvas.toDataURL(i):o.getCanvasBlob(this.blur_canvas,i,e),this.d_ctx=a,this.zoom_scale=h,this._resetDoodleScale(),this.blur_canvas.width=r,this.blur_canvas.height=_,this.temp_canvas.width=r,this.temp_canvas.height=_,s},getImageDataURL:function(t){return this._get_image("url",t)},getImageDataBlob:function(t,i){return this._get_image("blob",t,i)},_removeDoodle:function(t){null!==this.cur_textbox&&(this.unactiveTextbox(),this.textbox_editor.hide());var i=this.page.doodle_array,e=i.indexOf(t);i.splice(e,1),this._select_nothing(),this._clear_back()},_insertDoodle:function(t){this.page.doodle_array.unshift(t),this._clear_back()},_ur_insert:function(t){this.page.doodle_array.unshift(t),this._select_doodle(t),this._clear_back()},insertDoodle:function(t){var i=new e._DoodleNewCommand(t);this._insertDoodle(t),this.history.add(i)},unactiveTextbox:function(){null!==this.cur_textbox&&this.cur_textbox.actived&&(this.cur_textbox.unactive(),this.cur_textbox=null,this._select_nothing())},activeTextbox:function(){this._select_nothing(),this.cur_textbox.selected=!0,this.has_selected_doodle=!0,this.attachCurTextbox(),this.cur_textbox.active(),this.style_callback("btn","text")},attachCurTextbox:function(){this.edit_doodle.attachDoodle(this.cur_textbox),this._paintEditLayer()},activeInnerTextbox:function(){this.cur_textbox.active(),this.style_callback("btn","text")},delTextbox:function(t){var i=this.page.doodle_array.indexOf(t);0<=i&&this.page.doodle_array.splice(i,1),this.cur_textbox=null},paint:function(){this._paintDoodleLayer(),this._paintEditLayer(),this._paintChooseLayer()},_prepare_for_blur:function(){},_finish_for_blur:function(){},_paintDoodleLayer:function(){var t=this.bg_info,i=this.d_ctx,e=this.t_ctx,o=this.zoom_scale;i.save(),e.save(),i.lineCap="round",i.lineJoin="round",e.lineCap="round",e.lineJoin="round",i.scale(o,o),i.translate(-t.x,-t.y),e.scale(o,o),e.translate(-t.x,-t.y),i.clearRect(t.x,t.y,t.width,t.height),i.drawImage(t.image,t.x,t.y,t.width,t.height,t.x,t.y,t.width,t.height);for(var s=this.page.doodle_array,n=s.length-1;0<=n;n--)s[n].selected||s[n].draw(i);i.restore(),e.restore()},_clear_ctx:function(t){var i=this.bg_info;t.clearRect(i.x,i.y,i.width,i.height)},_select_nothing:function(){var t=this.page.doodle_array;this.has_selected_doodle=!1;for(var i=0;i<t.length;i++)t[i].selected=!1;this.edit_doodle.attachNothing(),this._select_back()},_select_doodle:function(t){for(var i=this.page.doodle_array,e=0;e<i.length;e++)i[e].selected=!1;this.has_selected_doodle=!0,t.selected=!0,this.edit_doodle.attachDoodle(t),this._select_back()},_paintEditLayer:function(){var t=this.page.doodle_array,e=this.e_ctx,o=this.bg_info,s=this.t_ctx,n=this.zoom_scale,a=o.width,h=o.height;e.save(),s.save(),e.lineCap="round",e.lineJoin="round",s.lineCap="round",s.lineJoin="round",e.scale(n,n),e.translate(-o.x,-o.y),s.scale(n,n),s.translate(-o.x,-o.y),e.clearRect(o.x,o.y,a,h),this.cut_mode&&(e.fillStyle="rgba(0, 0, 0, 0.3)",e.fillRect(o.x,o.y,a,h));for(var r=t.length-1;0<=r;r--)t[r].selected&&t[r].draw_select(e);var _=this.temp_doodle;function l(t,i,e){for(var o=i.edit_regions,s=0;s<o.length;s++)o[s].draw(t,e)}if(null!==_&&(_.type===i.Type.RECT_BLUR?_.draw_blur(e,this.blur_canvas):_.draw(e)),null!==this.cut_doodle)this.cut_doodle.draw(e),l(e,this.cut_doodle,this.zoom_scale);else if(this.__region_visible__){for(r=t.length-1;0<=r;r--)if(t[r].selected){l(e,t[r],this.zoom_scale);break}l(e,this.edit_doodle,this.zoom_scale)}e.restore(),s.restore()},_paintChooseLayer:function(){var t,i=this.page.doodle_array,e=this.c_ctx,o=this.bg_info,s=this.t_ctx,n=this.zoom_scale;if(e.save(),s.save(),e.lineCap="round",e.lineJoin="round",s.lineCap="round",s.lineJoin="round",e.scale(n,n),e.translate(-o.x,-o.y),s.scale(n,n),s.translate(-o.x,-o.y),e.clearRect(o.x,o.y,o.width,o.height),!this.cut_mode)for(t=i.length-1;0<=t;t--)i[t].draw_choose(e,t);null!==this.cut_doodle&&this.cut_doodle.draw_choose(e,i.length),e.restore(),s.restore()},cutImage:function(){null!==this.cur_textbox&&this.unactiveTextbox(),this.cut_saved={brush:this.style.brush_type,cursor:this.default_cursor,cursor_type:this.cursor_type},this.hideListDialog(),this.cursor_type=1,this.style.brush_type=i.Type.CUT,this.default_cursor="cursor_crosshair",this.setCursor_name(this.default_cursor),this.cut_mode=!0,this._select_nothing(),this.edit_doodle.attachNothing(),this.paint(),this.__cut_undo_command__=new e._CropCommand(this)},setCropSize:function(t,i){this.cut_mode&&(this.cut_doodle.setSize(t,i),this._paintEditLayer(),this._paintChooseLayer())},set_bg_info:function(t){var i=this.bg_info;i.x=t.x,i.y=t.y,i.width=t.w,i.height=t.h,this._resize(),this.paint()},finishCutImage:function(t){if(t&&null!==this.cut_doodle){var e=this.cut_doodle.points,o=Math.min(e[0].x,e[1].x),s=Math.min(e[0].y,e[1].y),n=Math.max(e[0].x,e[1].x),a=Math.max(e[0].y,e[1].y),h=this.bg_info;o=Math.max(o,h.x),s=Math.max(s,h.y),n=Math.min(n,h.x+h.width),a=Math.min(a,h.y+h.height),h.x=o,h.y=s,h.width=n-o,h.height=a-s,this._resize(),this._clear_back(),this.__cut_undo_command__.finish(),this.history.add(this.__cut_undo_command__),this.__cut_undo_command__=null;for(var r=this.page.doodle_array,_=i.Type,l=0;l<r.length;l++)r[l].type===_.TEXT?r[l]._calc():r[l].type===_.CALLOUT&&r[l].child_textbox._calc()}this.cursor_type=this.cut_saved.cursor_type,this.default_cursor=this.cut_saved.cursor,this.style.brush_type=this.cut_saved.brush,2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor),this.cut_mode=!1,this.cut_doodle=null,this.has_selected_doodle=!1,this.paint()},setBlurRadius:function(t){this.style.blur_radius=t},setPenWidth:function(t){this.style.pen_width=t;var i=this.page.doodle_array;if(this.has_selected_doodle){for(var o=0;o<i.length;o++)if(i[o].selected){var s=i[o].pen_width;i[o].setPenWidth(t),this.history.add(new e._DoodleWidthCommand(i[o],s,t));break}this.paint()}},setPenOpacity:function(t){this.style.pen_opacity=t,this._get_color()},setPenColor:function(t){this.style.pen_color=t,this._get_color()},setArrowType:function(t){this.style.arrow_type=t},setPenType:function(t){var e=i.Type[t.toUpperCase()];if((this.style.brush_type=e)===i.Type.LIST){var o=i._ListDoodle.__LAST_INFO__;o.color=this.style.color,this.default_cursor=o.getCursor(),this.setCursor(this.default_cursor),this.cursor_type=2}else this.default_cursor="cursor_"+t,this.setCursor_name(this.default_cursor),this.cursor_type=1},setSvgImage:function(t){this.style.svg_image=t},insertSvgImage:function(t){this.style.svg_image=t;var e=this.zoom_scale,o=this.container,s=this.out_container,n=Math.min(s.offsetWidth,o.offsetWidth),a=Math.min(s.offsetHeight,o.offsetHeight),h=t.width,r=t.height,_=s.scrollTop,l=s.scrollLeft,d=this.bg_info,c=Math.floor(((n-h*e)/2+l)/e),u=Math.floor(((a-r*e)/2+_)/e),f=i.create(i.Type.IMAGE,{drawer:this,image:this.style.svg_image.image,width:h,height:r,choose_type:t.choose_type,points:[{x:c+d.x,y:u+d.y},{x:c+d.x+h,y:u+d.y+r}]});f.initialize(),this.insertDoodle(f),this._select_doodle(f),this.paint()},_get_color:function(){var t=o.str2rgba(this.style.pen_color);this.style.color=o.rgba2str(t.r,t.g,t.b,this.style.pen_opacity),i._ListDoodle.__LAST_INFO__.color=this.style.color;var s=this.page.doodle_array;if(this.has_selected_doodle){for(var n=0;n<s.length;n++)if(s[n].selected){var a=s[n].color;s[n].setColor(this.style.color),this.history.add(new e._DoodleColorCommand(s[n],a,this.style.color));break}this.paint()}},_get_selected_shape:function(){if(this.has_selected_doodle)for(var t=this.page.doodle_array,i=0;i<t.length;i++)if(t[i].selected)return t[i];return null},setFontName:function(t){this.style.font_name=t;var e=i.Type,o=this.cur_textbox||this._get_selected_shape();null===o||o.type!==e.TEXT&&o.type!==e.INNERTEXT&&o.type!==e.CALLOUT||o.setFontName(t)},setFontSize:function(t){this.style.font_size=t;var e=i.Type,o=this.cur_textbox||this._get_selected_shape();null===o||o.type!==e.TEXT&&o.type!==e.INNERTEXT&&o.type!==e.CALLOUT||o.setFontSize(t)},undo:function(){this.history.undo(),this._ur_back()},redo:function(){this.history.redo(),this._ur_back()},_clear:function(){this.page.doodle_array.length=0,this.history.clear(),this._select_nothing(),this._clear_back()},clear:function(){this._clear(),this.d_changed=!0;var t=this.bg_info;t.x=0,t.y=0,t.width=t.origin_image.naturalWidth,t.height=t.origin_image.naturalHeight,t.image.width=t.width,t.image.height=t.height,this.i_ctx.drawImage(t.origin_image,0,0),this.reset_list(),this._resize(),this.paint(),this._clear_back()},saveOrigin:function(t){if(null!==this.bg_info.saved_origin)t();else{var i=new Image;i.src=o.image2url(this.bg_info.origin_image),i.onload=t,this.bg_info.saved_origin=i}},restoreOrigin:function(){this.bg_info.origin_image=this.bg_info.saved_origin},_ur_back:function(){this.style_callback("undo",this.history.canUndo()),this.style_callback("redo",this.history.canRedo())},_select_back:function(){this.style_callback("del",this.has_selected_doodle);var t=this.edit_doodle.selected_doodle,e=i.Type,o=null!==t?t.type:this.style.brush_type;o===e.LIST&&this.style.brush_type!==e.LIST&&(o=this.style.brush_type);var s=o===e.CALLOUT||o===e.TEXT?"text":o===e.LIST?"list":"other";this.style_callback("btn",s)},_clear_back:function(){this.style_callback("clear",!1===this.isEdited())},deleteSelected:function(){var t=null,i=this.page.doodle_array;if(this.has_selected_doodle)for(var o=0;o<i.length;o++)if(i[o].selected){t=i[o];break}null!==t&&(this._removeDoodle(t),this.history.add(new e._DoodleDelCommand(t)),this.paint())},reset_list:function(){i._ListDoodle.__LAST_INFO__.reset()},resetList:function(){var t=i._ListDoodle.__LAST_INFO__;this.reset_list(),this.default_cursor=t.getCursor(),this.setCursor(this.default_cursor),this.hideListDialog()},unSelectAll:function(){this._select_nothing(),this.edit_doodle.attachNothing(),this._paintDoodleLayer(),this.paint()}}}(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i){t._Doodle=function(t,i){this.type=t,this.drawer=i.drawer,this.points=i.points,this.color=void 0===i.color?"rgba(0,0,0,1.0)":i.color,this.highlight_color=this._calc_highlight_color(this.color),this.pen_width=void 0===i.pen_width?3:i.pen_width,this.line_type=void 0===i.line_type?0:i.line_type,this.fill_color=void 0===i.fill_color?null:i.fill_color,this.child_textbox=null,this.selected=!1,this.is_eraser=!!i.is_eraser,this.has_shadow=!1,this.region_points=i.region_points?i.region_points:this.points,this.initialized=!1,this.edit_regions=[],this.boundary={left:0,top:0,height:0,width:0}},t.Type={CURVE:1,LINE:2,RECT:3,ELLIPSE:4,HIGHLIGHT:1,RECT_BLUR:5,CURVE_BLUR:6,CALLOUT:7,LIST:8,LINE_ARROW:20,CURVE_ARROW:21,BEZIER_ARROW:22,BIG_HEAD_ARROW:23,IMAGE:30,ERASER:60,TEXT:80,INNERTEXT:81,CUT:8888,EDITHELPER:999},t.LineType={NORMAL:0,DASH_ONE:1,DASH_TWO:2,DASH_THREE:4,LEFT_ARROW:8,RIGHT_ARROW:16,DOUBLE_ARROW:32,SEED:128,FILL:256,MATRIX:512},t.create=function(e,o){var s=t.Type;switch(e){case s.ERASER:return new t._SimpleEraserDoodle(o);case s.LINE:return new t._LineDoodle(o);case s.RECT:return new t._RectDoodle(o);case s.ELLIPSE:return new t._EllipseDoodle(o);case s.CURVE:return new t._CurveDoodle(o);case s.RECT_BLUR:return new t._RectBlurDoodle(o);case s.CURVE_BLUR:return new t._CurveBlurDoodle(o);case s.TEXT:return new t._TextboxDoodle(o);case s.INNERTEXT:return new t._InnerTextboxDoodle(o);case s.CUT:return new t._CutDoodle(o);case s.CALLOUT:return new t._CalloutDoodle(o);case s.LIST:return new t._ListDoodle(o);case s.IMAGE:return new t._ImageDoodle(o);case s.LINE_ARROW:return new t._LineArrowDoodle(o);case s.BIG_HEAD_ARROW:return new t._BigHeadArrowDoodle(o);case s.CURVE_ARROW:return new t._CurveArrowDoodle(o);case s.BEZIER_ARROW:return new t._BezierArrowDoodle(o);default:return i.log("unkown type of doodle: "+e),new t._CurveDoodle(o)}},t._Doodle.prototype={setRegionDisabled:function(t){for(var i=0;i<this.edit_regions.length;i++)this.edit_regions[i].disabled=t},initialize:function(){this.initialized=!0},onRegionEdit:function(t,i){},onRegionEditStart:function(t,i){},onRegionEditFinish:function(t,i){},getRotateUndoCommand:function(){return null},getMoveUndoCommand:function(){return null},getRegionUndoCommand:function(){return null},afterUndoRedo:function(){this._calc(),this.drawer._select_doodle(this)},_create_edit_region:function(){for(var i=0;i<this.region_points.length;i++)this.edit_regions.push(new t.CircleRegion(this,i,this.region_points[i],Math.round((Math.max(this.pen_width,8)+6)/2),"pointer"))},setPenWidth:function(t){this.pen_width=t;for(var i=0;i<this.edit_regions.length;i++)this.edit_regions[i].radius=Math.round((Math.max(this.pen_width,8)+6)/2)},setColor:function(t){this.color=t,this.highlight_color=this._calc_highlight_color(t)},_calc_highlight_color:function(){var t=i.str2rgba(this.color);return 200<=t.r&&200<=t.b&&200<=t.g?"rgba(0,0,0,0.3)":"rgba(255, 255, 255, "+t.a+")"},getSelectedColor:function(){},getRotatePoint:function(){return null},_calc_1:function(t){for(var i=t[0],e=i.x,o=i.y,s=i.x,n=i.y,a=this.boundary,h=0;h<t.length;h++)(i=t[h]).x<e&&(e=i.x),i.x>s&&(s=i.x),i.y<o&&(o=i.y),i.y>n&&(n=i.y);a.width=s-e,a.height=n-o,a.left=e,a.top=o,a.right=s,a.bottom=n},_calc_2:function(t,i,e,o){var s=this.boundary;s.width=Math.abs(t-e),s.height=Math.abs(i-o),s.left=Math.min(t,e),s.top=Math.min(i,o),s.right=s.left+s.width,s.bottom=s.top+s.height},set_child_textbox:function(){},_doDraw:function(t,i,e,o,s){throw"abstract method _doDraw"},draw_choose:function(t,e){var o=i.int2color(e);t.strokeStyle=o,t.fillStyle=o,t.lineWidth=Math.round(1.5*this.pen_width),this._doChooseDraw(t,o)},draw_select:function(t){t.save(),t.strokeStyle=this.highlight_color,t.shadowColor="rgba(0, 0, 0, 0.4)",t.shadowOffsetX=0,t.shadowOffsetY=2,t.shadowBlur=4,t.lineWidth=Math.floor(this.pen_width+6),this._doSelectDraw(t),t.restore(),this.draw(t)},draw_region:function(t,i,e){this.draw_select(t,e);for(var o=0;o<this.edit_regions.length;o++)this.edit_regions[o].draw(t,i)},_doChooseDraw:function(t,i){this._doDraw(t,i)},_doSelectDraw:function(t){this._doDraw(t)},draw:function(t,i,e,o){throw"abstruct methon draw"},drawFPT:function(t,i,e,o){this.draw(t,i,e,o)},_typed_draw:function(e){e.save(),e.strokeStyle=this.color,e.lineWidth=this.pen_width;var o=t.LineType,s=null,n=this.line_type;0<(n&o.DASH_ONE)?i.setLineDash(e,[1,5]):0<(n&o.DASH_TWO)?i.setLineDash(e,[6,5]):0<(n&o.DASH_THREE)&&i.setLineDash(e,[6,5,1,5]),0<(n&o.LEFT_ARROW)?s=this._drawLeftArrow:0<(n&o.RIGHT_ARROW)?s=this._drawRightArrow:0<(n&o.DOUBLE_ARROW)&&(s=this._drawDoubleArrow),this._doDraw(e,this.fill_color,this.has_shadow),null!==s&&s.call(this,e),e.restore(),null!==this.child_textbox&&this.child_textbox.draw(e)},_normal_draw:function(t,i,e,o){t.strokeStyle=this.color,t.lineWidth=this.pen_width,this._doDraw(t,this.fill_color,i,e,o)},editMove:function(t,i){throw"absolute method editMove"},editRotateScale:function(t,i,e,o){throw"absolute method editRotateScale"},rotateScale:function(t,i,e){throw"absolute method rotateScale"},move:function(t,i){throw"absolute method move"},editStart:function(t){throw"absolute methon editStart"},editFinish:function(t){this._calc()},editPushPoint:function(t){throw"absolute method editPushPoint"},_drawLeftArrow:function(t){},_drawRightArrow:function(t){},_drawDoubleArrow:function(t){this._drawLeftArrow(t),this._drawRightArrow(t)},setFillColor:function(t){return!1},resetScale:function(){}}}(Diigo.Doodle,Diigo.$),function(t,i,e){t._CommonDoodle=function(t,i){this.base(t,i),this.pre_points=e.copyPoints(this.points),this.rotate_point={x:0,y:0},this._calc()},t._CommonDoodle.prototype={getRotatePoint:function(){return null},getMoveUndoCommand:function(t){return new i._DoodlePointsCommand(this)},_calc:function(){this._calc_1(this.points);var t=this.boundary;this.rotate_point.x=Math.floor(t.left+t.width/2),this.rotate_point.y=t.top-20},draw:function(t,i,e,o){this._typed_draw(t,i,e,o)},editMove:function(t,i){for(var e=0;e<this.points.length;e++)this.points[e].x=this.pre_points[e].x+t,this.points[e].y=this.pre_points[e].y+i;this._calc()},move:function(t,i){for(var e=0;e<this.points.length;e++)this.points[e].x+=t,this.points[e].y+=i;this._calc()},editStart:function(){e.setPoints(this.pre_points,this.points)},editPushPoint:function(t){this.points.push(t),this.pre_points.push({x:0,y:0}),this._calc()}},e.inherit(t._CommonDoodle,t._Doodle),t._CurveDoodle=function(i){if(1===i.points.length){var e=i.points[0],o=i.pen_width,s={x:e.x+o/4,y:e.y};i.points.push(s)}this.base(t.Type.CURVE,i)},t._CurveDoodle.prototype={_doDraw:function(t){e.drawBesier(t,this.points)},_drawLeftArrow:function(t){var i=this.points,o=i[0],s=1<i.length?i[1]:o;e.drawArrow(t,s.x,s.y,o.x,o.y)},_drawRightArrow:function(t){var i=this.points,o=i[i.length-1],s=1<i.length?i[i.length-2]:o;e.drawArrow(t,s.x,s.y,o.x,o.y)}},e.inherit(t._CurveDoodle,t._CommonDoodle),t._LineDoodle=function(i){1===i.points.length&&i.points.push({x:i.points[0].x,y:i.points[0].y}),this.base(t.Type.LINE,i),this.region_points=this.points,this._create_edit_region()},t._LineDoodle.prototype={_calc:function(){var t=this.points;this._calc_2(t[0].x,t[0].y,t[1].x,t[1].y)},_doDraw:function(t){var i=this.points;e.drawLine(t,i[0].x,i[0].y,i[1].x,i[1].y)},_drawLeftArrow:function(t){var i=this.points,o=i[0],s=i[1];e.drawArrow(t,s.x,s.y,o.x,o.y)},_drawRightArrow:function(t){var i=this.points,o=i[1],s=i[0];e.drawArrow(t,s.x,s.y,o.x,o.y)},editPushPoint:function(t){this.points[1].x=t.x,this.points[1].y=t.y,this._calc()},getRegionUndoCommand:function(){return new i._DoodlePointsCommand(this)},onRegionEdit:function(t,i){this.points[t].x=i.x,this.points[t].y=i.y,this._calc(),this.drawer.edit_doodle.attachDoodle(this)},onRegionEditFinish:function(t,i){this.drawer.edit_doodle.attachDoodle(this)}},e.inherit(t._LineDoodle,t._CommonDoodle),t._LineArrowDoodle=function(t){this.arrow_info={idx:0,pos:{}},this.base(t)},t._LineArrowDoodle.prototype={setPenWidth:function(t){this.callBase("setPenWidth",t),this._calc_arrow()},draw:function(t){var i=this.drawer.t_ctx,e=this.drawer.bg_info;i.save(),i.fillStyle=this.color,i.strokeStyle=this.color,i.lineWidth=this.pen_width,i.clearRect(e.x,e.y,e.width,e.height),this._doDraw(i),i.restore(),t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(i.canvas,0,0),t.restore()},_calc_arrow:function(){var t=this.points,i=5*this.pen_width;this.arrow_info.idx=e.getPTPRange(t[0],t[1])>i?1:0,this.arrow_info.pos=e.calcArrow(t[0].x,t[0].y,t[1].x,t[1].y,i)},_doDraw:function(t,i){var e=this.points,o=this.arrow_info,s=o.pos,n=0===o.idx;t.beginPath(),n?(t.beginPath(),t.moveTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.closePath(),t.fill()):(t.moveTo(e[0].x,e[0].y),t.lineTo(s.cx,s.cy),i?(t.lineTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.lineTo(s.cx,s.cy),t.stroke()):(t.stroke(),t.closePath(),t.beginPath(),t.moveTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.closePath(),t.save(),t.globalCompositeOperation="destination-out",t.fillStyle="black",t.fill(),t.restore(),t.fill()))},_calc:function(){this.callBase("_calc"),this._calc_arrow()},_doSelectDraw:function(t){this._doDraw(t,!0)},_doChooseDraw:function(t,i){this._doDraw(t,!1)}},e.inherit(t._LineArrowDoodle,t._LineDoodle),t._BigHeadArrowDoodle=function(t){this.arrow_info={idx:0,pos:{}},this.base(t)},t._BigHeadArrowDoodle.prototype={setPenWidth:function(t){this.callBase("setPenWidth",t),this._calc_arrow()},draw:function(t){var i=this.drawer.t_ctx,e=this.drawer.bg_info;i.save(),i.fillStyle=this.color,i.strokeStyle=this.color,i.lineWidth=this.pen_width-1,i.clearRect(e.x,e.y,e.width,e.height),this._doDraw(i),i.restore(),t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(i.canvas,0,0),t.restore()},_calc_arrow:function(){var t=this.points,i=8*this.pen_width;this.arrow_info.idx=e.getPTPRange(t[0],t[1])>i?1:0,this.arrow_info.pos=e.calcArrow_new(t[0].x,t[0].y,t[1].x,t[1].y,i)},_doDraw:function(t,i){var e=this.points,o=this.arrow_info,s=o.pos,n=0===o.idx;t.beginPath(),n?(t.beginPath(),t.moveTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.closePath(),t.fill()):(t.moveTo(e[0].x,e[0].y),t.lineTo(s.ex,s.ey),t.lineTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.lineTo(s.fx,s.fy),t.closePath(),t.fill(),t.moveTo(s.cx,s.cy),t.lineTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.lineTo(s.cx,s.cy),t.stroke())},_calc:function(){this.callBase("_calc"),this._calc_arrow()},_doSelectDraw:function(t){this._doDraw(t,!0)},_doChooseDraw:function(t,i){this._doDraw(t,!1)}},e.inherit(t._BigHeadArrowDoodle,t._LineDoodle),t._CurveArrowDoodle=function(t){this.arrow_info={idx:0,pos:{}},this.base(t)},t._CurveArrowDoodle.prototype={setPenWidth:function(t){this.callBase("setPenWidth",t),this._calc_arrow()},draw:function(t){var i=this.drawer,e=i.t_ctx,o=i.bg_info;e.save(),e.fillStyle=this.color,e.strokeStyle=this.color,e.lineWidth=this.pen_width,e.clearRect(o.x,o.y,o.width,o.height),this._doDraw(e),e.restore(),t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(e.canvas,0,0),t.restore()},_doDraw:function(t,i){var o=this.points,s=this.arrow_info,n=s.pos,a=0===s.idx;if(t.beginPath(),a)t.beginPath(),t.moveTo(n.cx,n.cy),t.lineTo(n.ax,n.ay),t.lineTo(n.dx,n.dy),t.lineTo(n.bx,n.by),t.closePath(),t.fill();else{var h=null,r=o[0];t.moveTo(r.x,r.y);for(var _=0;_<s.idx;_++)h=e.getMiddlePoint(o[_],o[_+1]),t.quadraticCurveTo(r.x,r.y,h.x,h.y),r=o[_+1];var l={x:n.cx,y:n.cy};h=e.getMiddlePoint(o[s.idx],l),t.quadraticCurveTo(r.x,r.y,h.x,h.y),h=r=l,t.quadraticCurveTo(r.x,r.y,h.x,h.y),i||(t.stroke(),t.closePath(),t.beginPath(),t.moveTo(n.cx,n.cy)),t.lineTo(n.ax,n.ay),t.lineTo(n.dx,n.dy),t.lineTo(n.bx,n.by),i?(t.lineTo(n.cx,n.cy),t.stroke()):(t.closePath(),t.save(),t.globalCompositeOperation="destination-out",t.fillStyle="black",t.fill(),t.restore(),t.fill())}},_calc:function(){this.callBase("_calc"),this._calc_arrow()},_calc_arrow:function(){var t=this.points,i=5*this.pen_width,o=t.length-1;if(!(o<=0)){for(;0<o&&!(i<=e.getPTPRange(t[t.length-1],t[o-1])||1===o);)o--;this.arrow_info.idx=o-1,this.arrow_info.pos=e.calcArrow(t[o-1].x,t[o-1].y,t[t.length-1].x,t[t.length-1].y,i)}},_doSelectDraw:function(t){this._doDraw(t,!0)},_doChooseDraw:function(t,i){this._doDraw(t,!1)}},e.inherit(t._CurveArrowDoodle,t._CurveDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){t._MatrixDoodle=function(t,i){1===i.points.length&&i.points.push({x:i.points[0].x,y:i.points[0].y}),this.base(t,i),this.matrix=null==i.matrix?[1,0,0,0,1,0,0,0,0]:i.matrix,this.line_type|=512,this.pre_matrix=e.copyArray(this.matrix),this.region_points=[],this.rotate_point={x:0,y:0},this.region_points=e.genPoints(i.region_number?i.region_number:4),this._calc(),this._create_edit_region()},t._MatrixDoodle.prototype={getRotatePoint:function(){return this.rotate_point},_create_edit_region:function(){for(var i=0;i<this.region_points.length;i++)this.edit_regions.push(new t.CircleRegion(this,i,this.region_points[i],Math.round((Math.max(this.pen_width,8)+6)/2),"pointer"))},getMoveUndoCommand:function(){return new i._DoodleMatrixCommand(this)},getRegionUndoCommand:function(){return new i._DoodlePointsCommand(this)},getRotateUndoCommand:function(){return new i._DoodleMatrixCommand(this)},_calcBeforeMatrixPoint:function(t,i,e){var o=t[3]*t[1]-t[0]*t[4];if(0==o)return alert("0"),null;var s,n=((e-t[5])*t[1]-(i-t[2])*t[4])/o;if(0!==t[1])s=(i-t[2]-t[0]*n)/t[1];else{if(0===t[4])return alert("0"),null;s=(e-t[5]-t[3]*n)/t[4]}return{x:Math.floor(n),y:Math.floor(s)}},_calcBeforeMatrixWidth:function(t,i,e,o,s){var n=t[3]*t[1]-t[0]*t[4];if(0==n)return alert("0"),-1;var a=((e-t[5])*t[1]-(i-t[2])*t[4])/n,h=((s-t[5])*t[1]-(o-t[2])*t[4])/n;return Math.abs(Math.floor(a-h))},_onRegionEdit:function(t,i,e){var o=this._calcBeforeMatrixPoint(this.matrix,i.x,i.y),s=o.x,n=o.y,a=e[0],h=e[1];if(8===this.region_points.length)switch(t){case 0:a.x=s,a.y=n;break;case 1:a.y=n;break;case 2:h.x=s,a.y=n;break;case 3:h.x=s;break;case 4:h.x=s,h.y=n;break;case 5:h.y=n;break;case 6:a.x=s,h.y=n;break;case 7:a.x=s}else switch(t){case 0:a.x=s,a.y=n;break;case 1:h.x=s,a.y=n;break;case 2:h.x=s,h.y=n;break;case 3:a.x=s,h.y=n}},onRegionEdit:function(t,i){this._onRegionEdit(t,i,this.points),this._calc(),this.drawer.edit_doodle.attachDoodle(this)},set_child_textbox:function(t){this.child_textbox=t,this._calc_boundary()},_calc_boundary:function(){var t=this.boundary,i=this.child_textbox.boundary;t.left=Math.min(t.left,i.left),t.right=Math.max(t.right,i.right),t.top=Math.min(t.top,i.top),t.bottom=Math.max(t.bottom,i.bottom)},_calc:function(){var t,i,e,o,s,n,a,h,r=this.matrix,_=this.points,l=(_[0].x+_[1].x)/2,d=(_[0].y+_[1].y)/2,c=Math.min(_[0].y,_[1].y)-this.pen_width/2-25;function u(t,i){return Math.floor(r[0]*t+r[1]*i+r[2])}function f(t,i){return Math.floor(r[3]*t+r[4]*i+r[5])}t=u(_[0].x,_[0].y),s=f(_[0].x,_[0].y),i=u(_[1].x,_[0].y),n=f(_[1].x,_[0].y),e=u(_[1].x,_[1].y),a=f(_[1].x,_[1].y),o=u(_[0].x,_[1].y),h=f(_[0].x,_[1].y);var p=this.region_points;8===p.length?(p[0].x=t,p[0].y=s,p[1].x=u(l,_[0].y),p[1].y=f(l,_[0].y),p[2].x=i,p[2].y=n,p[3].x=u(_[1].x,d),p[3].y=f(_[1].x,d),p[4].x=e,p[4].y=a,p[5].x=u(l,_[1].y),p[5].y=f(l,_[1].y),p[6].x=o,p[6].y=h,p[7].x=u(_[0].x,d),p[7].y=f(_[0].x,d)):(p[0].x=t,p[0].y=s,p[1].x=i,p[1].y=n,p[2].x=e,p[2].y=a,p[3].x=o,p[3].y=h),this.rotate_point.x=u(l,c),this.rotate_point.y=f(l,c),this._calc_2(Math.min(t,i,e,o),Math.min(s,n,a,h),Math.max(t,i,e,o),Math.max(s,n,a,h))},draw:function(t,i,e,o){this._typed_draw(t,i,e,o)},editStart:function(){e.setArray(this.pre_matrix,this.matrix),null!==this.child_textbox&&this.child_textbox.editStart()},editFinish:function(){this._calc(),null!==this.child_textbox&&(this.child_textbox.editFinish(),this._calc_boundary())},editMove:function(t,i){this.matrix[2]=this.pre_matrix[2]+t,this.matrix[5]=this.pre_matrix[5]+i,this._calc(),null!==this.child_textbox&&this.child_textbox.editMove()},move:function(t,i){this.matrix[2]+=t,this.matrix[5]+=i,this._calc()},rotateScale:function(t,i,o){e.setArray(this.pre_matrix,this.matrix),this.editRotateScale(t,i,o)},editRotateScale:function(t,i,e,o){var s=this.matrix,n=this.pre_matrix,a=1*Math.sin(i),h=1*Math.cos(i),r=t.x,_=t.y;s[0]=h*n[0]-a*n[3],s[1]=h*n[1]-a*n[4],s[2]=h*n[2]-a*n[5]-h*r+a*_+r,s[3]=a*n[0]+h*n[3],s[4]=a*n[1]+h*n[4],s[5]=a*n[2]+h*n[5]-a*r-h*_+_,!0!==o&&this._calc(),null!==this.child_textbox&&this.child_textbox.editRotateScale()},editPushPoint:function(t){this.points[1].x=t.x,this.points[1].y=t.y,this._calc()},setFillColor:function(t){return this.fill_color="string"!=typeof t?null:t,!0},resetZoomScale:function(){null!==this.child_textbox&&this.child_textbox.resetZoomScale()}},e.inherit(t._MatrixDoodle,t._Doodle),t._RectDoodle=function(i){this.base(t.Type.RECT,i)},t._RectDoodle.prototype={_doDraw:function(t,i){var e=this.points;t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.lineTo(e[0].x,e[1].y),t.closePath(),null!==i&&(t.fillStyle=i,t.fill()),t.stroke(),t.restore()},_doChooseDraw:function(t,i){this._doDraw(t,null!==this.fill_color?i:null)},_doSelectDraw:function(t){this._doDraw(t,null)}},e.inherit(t._RectDoodle,t._MatrixDoodle),t._EllipseDoodle=function(i){this.center={x:0,y:0},this.radius={a:0,b:0},this.base(t.Type.ELLIPSE,i)},t._EllipseDoodle.prototype={_calc:function(){var t=this.points;this.center.x=Math.round((t[0].x+t[1].x)/2),this.center.y=Math.round((t[0].y+t[1].y)/2),this.radius.a=Math.round(Math.abs(t[0].x-t[1].x)/2),this.radius.b=Math.round(Math.abs(t[0].y-t[1].y)/2),this.callBase("_calc")},_doDraw:function(t,i){t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),e.drawEllipse(t,this.center.x,this.center.y,this.radius.a,this.radius.b,i),t.restore()},_doChooseDraw:function(t,i){this._doDraw(t,null!==this.fill_color?i:null)},_doSelectDraw:function(t){this._doDraw(t,null)}},e.inherit(t._EllipseDoodle,t._MatrixDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e,o){i._TextboxDoodle=function(e){1===e.points.length&&e.points.push({x:e.points[0].x,y:e.points[0].y}),this.base(i.Type.TEXT,e),this.editor=this.drawer.textbox_editor,this.matrix=[1,0,0,0,1,0,0,0,0],this.pre_matrix=o.copyArray(this.matrix),this.editor_matrix=o.copyArray(this.matrix),this.style=e.style?e.style:new t._Style(this.drawer.style),this.page_idx=this.editor.createPage(this.style),this.actived=!1,this.auto_width=!1!==e.auto_width,this.size={width:0,height:0},this.center={x:0,y:0},this.rotate_point={x:0,y:0},this._ur_timeout=null,this._ur_value=this.editor.getPageByIdx(this.page_idx).text,this._ur_handler=o.createDelegate(this,this._deal_ur),this._calc()},i._TextboxDoodle.prototype={afterUndoRedo:function(){this._calc(),this.actived?this.resetOutline():null!==this.drawer.cur_textbox&&this.drawer.cur_textbox!==this&&this.drawer.unactiveTextbox(),this.drawer._select_doodle(this)},getRotatePoint:function(){return this.rotate_point},getMoveUndoCommand:function(){return new e._DoodleMatrixCommand(this)},getRegionUndoCommand:function(){return new e._DoodlePointsCommand(this)},getRotateUndoCommand:function(){return new e._DoodleMatrixCommand(this)},setURText:function(t){var i=this.editor.getPageByIdx(this.page_idx);i.text=t,i.initParagraph(),this.actived&&(this.auto_width&&this._calc_text_outline(t),this.editor.textarea.value=t,this.editor.textarea.focus())},setColor:function(t){this.style.color=t,this.editor.textarea.style.color=this.style.color},setFontName:function(t){this.style.setFontName(t),this._resetFont()},setFontSize:function(t){this.style.setFontSize(t),this._resetFont()},setTextBackground:function(t){this.style.setTextBackground(t),this.editor.textarea.style.color=t?this._calc_highlight_color(this.style.color):this.style.color,this._resetFont()},_calc_highlight_color:function(t){return o.str2rgba(t),"#fff"===t||"rgba(255,255,255,1)"===t?"black":"#fff"},_resetFont:function(){this.style.getScaleFont(this.drawer.zoom_scale);var t=this.style.getScaleFontForTextArea(this.drawer.zoom_scale);if(this.actived)this.editor.cur_page.resetFont(),this.editor.textarea.style.font=t,this.editor.textarea.style.lineHeight=o.getFontInfo(t).height+"px",this.onTextInput(this.editor.textarea.value);else{var i=this.editor.getPageByIdx(this.page_idx);if(i.resetFont(),this.auto_width)this._calc_text_outline(i.text);else{var e=this.editor;e.save_state(),e._setCurPage(this.page_idx),i.initParagraph(),e.restore_state()}this.drawer.edit_doodle._re_attach_doodle(),this.drawer._paintEditLayer()}},initialize:function(){var t=this.points;if(t[1].y<t[0].y){var i=t[0];t[0]=t[1],t[1]=i}if(t[1].x<t[0].x){var e=t[0].x;t[0].x=t[1].x,t[1].x=e}var o=this.editor.getPageHeight(this.page_idx);this.auto_width?(this.size.width=20,this.size.height=o):(this.size.width=Math.max(20,t[1].x-t[0].x),this.size.height=Math.max(50,t[1].y-t[0].y)),this.matrix[2]=t[0].x,this.matrix[5]=t[0].y,t[0].x=0,t[0].y=0,t[1].x=this.size.width,t[1].y=this.size.height,this.initialized=!0,this._setAutoWidth(this.auto_width),this._calc(),this.resetOutline()},_setAutoWidth:function(t){this.editor.setBoxAutoWidth(t)},editStart:function(){o.setArray(this.pre_matrix,this.matrix)},editMove:function(t,i){this.matrix[2]=this.pre_matrix[2]+t,this.matrix[5]=this.pre_matrix[5]+i,this._calc()},move:function(t,i){this.matrix[2]+=t,this.matrix[5]+=i,this._calc()},rotateScale:function(t,i,e){o.setArray(this.pre_matrix,this.matrix),this.editRotateScale(t,i,e)},editRotateScale:function(t,i,e){this.is_rotating||(this.is_rotating=!0);var o=this.matrix,s=this.pre_matrix,n=Math.sin(i),a=Math.cos(i),h=t.x,r=t.y;o[0]=a*s[0]-n*s[3],o[1]=a*s[1]-n*s[4],o[2]=a*s[2]-n*s[5]-a*h+n*r+h,o[3]=n*s[0]+a*s[3],o[4]=n*s[1]+a*s[4],o[5]=n*s[2]+a*s[5]-n*h-a*r+r,this._calc(),this.actived&&(this.resetMatrix(),this._resetSize())},editPushPoint:function(t){},_calc_editor_matrix:function(){var t=this.matrix,i=this.editor_matrix,e=this.drawer.zoom_scale,s=(this.center.x-this.drawer.bg_info.x)*e,n=(this.center.y-this.drawer.bg_info.y)*e,a=Math.sqrt(t[0]*t[4]-t[1]*t[3])*e;o.setArray(i,[1,0,0,0,1,0,0,0,0]),i[2]=s-this.size.width*a/2,i[5]=n-this.size.height*a/2;var h=Math.atan2(t[4],t[1])-Math.PI/2,r=Math.cos(h),_=Math.sin(h),l=r*i[0]-_*i[3],d=r*i[1]-_*i[4],c=r*i[2]-_*i[5]-r*s+_*n+s,u=_*i[0]+r*i[3],f=_*i[1]+r*i[4],p=_*i[2]+r*i[5]-_*s-r*n+n;i[0]=l,i[1]=d,i[2]=c,i[3]=u,i[4]=f,i[5]=p},resetScale:function(){this._calc_editor_matrix(),this.resetOutline(),this.resetFont()},resetFont:function(){var t=this.matrix,i=Math.sqrt(t[0]*t[4]-t[1]*t[3])*this.drawer.zoom_scale;this.editor.textarea.style.font=this.editor.cur_page.style.getScaleFontForTextArea(i)},resetOutline:function(){this.actived&&(this._resetSize(),this.editor.setBoxMatrix(this.editor_matrix))},_resetSize:function(){var t=this.matrix,i=Math.sqrt(t[0]*t[4]-t[1]*t[3])*this.drawer.zoom_scale,e=this.size.width,o=this.size.height;this.editor.setBoxSize_scale(e,o,i)},_setDrawSize:function(){var t=this.matrix,i=Math.sqrt(t[0]*t[4]-t[1]*t[3])*this.drawer.zoom_scale,e=this.size.width,o=this.size.height;this.editor.set_drawtext_size(e,o,i)},_calc_text_outline:function(t){var i=this.editor,e=t.split("\n"),o=20,s=i.render.ctx,n=this.points;s.save(),s.font=i.cur_page.style.font;for(var a=0;a<e.length;a++){var h=s.measureText(e[a]).width;o<h&&(o=h)}s.restore();var r=i.cur_page.line_height*e.length;this.size.width=Math.ceil(o)+21,this.size.height=Math.ceil(r),n[1].x=this.size.width,n[1].y=this.size.height,this._resetSize(),this._calc()},onTextInput:function(t){this.auto_width&&(this._calc_text_outline(t),this.drawer.edit_doodle._re_attach_doodle(),this.drawer._paintEditLayer())},resetMatrix:function(){this.setBoxMatrix(this.editor_matrix)},setBoxMatrix:function(t){this.editor.setBoxMatrix(t)},_calc:function(t){var i,e,o,s,n,a,h,r,_=this.matrix,l=this.points,d=(l[0].x+l[1].x)/2,c=Math.min(l[0].y,l[1].y)-20;i=_[0]*l[0].x+_[1]*l[0].y+_[2],n=_[3]*l[0].x+_[4]*l[0].y+_[5],e=_[0]*l[1].x+_[1]*l[0].y+_[2],a=_[3]*l[1].x+_[4]*l[0].y+_[5],o=_[0]*l[1].x+_[1]*l[1].y+_[2],h=_[3]*l[1].x+_[4]*l[1].y+_[5],s=_[0]*l[0].x+_[1]*l[1].y+_[2],r=_[3]*l[0].x+_[4]*l[1].y+_[5];var u=(l[0].x+l[1].x)/2,f=(l[0].y+l[1].y)/2;this.center.x=Math.floor(_[0]*u+_[1]*f+_[2]),this.center.y=Math.floor(_[3]*u+_[4]*f+_[5]),this.rotate_point.x=Math.floor(_[0]*d+_[1]*c+_[2]),this.rotate_point.y=Math.floor(_[3]*d+_[4]*c+_[5]),this._calc_2(Math.min(i,e,o,s),Math.min(n,a,h,r),Math.max(i,e,o,s),Math.max(n,a,h,r)),t||this._calc_editor_matrix()},_deal_ur:function(){var t=this.editor.textarea.value;this._ur_value!==t&&(this.drawer.history.add(new e._DoodleTextCommand(this,this._ur_value,t)),this._ur_value=t)},onTextPress:function(){null!==this._ur_timeout&&window.clearTimeout(this._ur_timeout),this._ur_timeout=window.setTimeout(this._ur_handler,300)},active:function(){this._doActive(),this.editor.textarea.style.paddingLeft=6*this.drawer.zoom_scale/window.devicePixelRatio+"px",this.style.textBackground?(this.editor.textarea.style.backgroundColor=this.style.color,this.editor.textarea.style.color=this._calc_highlight_color(this.style.color)):(this.editor.textarea.style.backgroundColor="transparent",this.editor.textarea.style.color=this.style.color)},_doActive:function(){this.actived=!0,this.drawer.paint(),(this.editor.floated_textbox=this).editor.setCurPage(this.page_idx),this._setAutoWidth(this.auto_width),this.resetOutline();var t=this.editor;t.show(),t.focus()},unactive:function(){this.actived=!1;var t=this.editor;t.blur(),t.hide(),""===t.textarea.value.trim()?this.drawer.delTextbox(this):(t.cur_page.text=t.textarea.value,t.cur_page.initParagraph())},_doDraw:function(t,i,e){var s=this.points;t.save(),t.lineWidth=2,o.setLineDash(t,[6,5]),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),this.style.textBackground?(i?t.fillStyle=i:e&&(t.strokeStyle=e),function(t,i,e,o,s,n,a,h){if(void 0===h&&(h=!0),void 0===n&&(n=5),"number"==typeof n)n={tl:n,tr:n,br:n,bl:n};else{var r={tl:0,tr:0,br:0,bl:0};for(var _ in r)n[_]=n[_]||r[_]}t.beginPath(),t.moveTo(i+n.tl,e),t.lineTo(i+o-n.tr,e),t.quadraticCurveTo(i+o,e,i+o,e+n.tr),t.lineTo(i+o,e+s-n.br),t.quadraticCurveTo(i+o,e+s,i+o-n.br,e+s),t.lineTo(i+n.bl,e+s),t.quadraticCurveTo(i,e+s,i,e+s-n.bl),t.lineTo(i,e+n.tl),t.quadraticCurveTo(i,e,i+n.tl,e),t.closePath(),t.shadowColor="rgba(0,0,0,.3)",t.shadowBlur=5,t.shadowOffsetX=2,t.shadowOffsetY=2,t.fill(),h&&t.stroke()}(t,s[0].x,s[0].y,Math.abs(s[0].x-s[1].x),Math.abs(s[0].y-s[1].y),6,0,!1)):(t.beginPath(),t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[0].y),t.lineTo(s[1].x,s[1].y),t.lineTo(s[0].x,s[1].y),t.closePath(),i?(t.fillStyle=i,t.fill()):e&&(t.strokeStyle=e,t.stroke())),t.restore()},draw_select:function(t,i){this.style.textBackground?this._doDraw(t,this.style.color,this.style.color):this._doDraw(t,null,this.style.color),this.actived||this._draw_text(t)},_doChooseDraw:function(t,i){this._doDraw(t,i,null)},_draw_text:function(t){var i=this.editor_matrix,e=this.editor;e.save_state(),t.save(),t.setTransform(1,0,0,1,0,0),t.transform(i[0],i[3],i[1],i[4],i[2],i[5]),e._setCurPage(this.page_idx),this._setDrawSize(),this.editor.render.paintToContext(t,this.style),t.restore(),e.restore_state()},draw:function(t){this.initialized?this.actived?this.actived&&(this.style.textBackground?this._doDraw(t,this.style.color,this._calc_highlight_color(this.style.color)):this._doDraw(t,null,this.style.color)):(this.style.textBackground&&this._doDraw(t,this.style.color,this._calc_highlight_color(this.style.color)),this._draw_text(t)):this.style.textBackground?this._doDraw(t,this.style.color,this._calc_highlight_color(this.style.color)):this._doDraw(t,null,this.style.color)}},o.inherit(i._TextboxDoodle,i._Doodle)}(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e,o){i._InnerTextboxDoodle=function(t){this.base(t),this.type=i.Type.INNERTEXT,this.parent_doodle=void 0!==t.parent_doodle?t.parent_doodle:null,this.center={x:0,y:0},this.auto_width=!1;var e=o.str2rgba(this.style.color),s=.299*e.r+.587*e.g+.114*e.b;this.style.color=170<s?"#000":"#fff",this.edit_height=0},i._InnerTextboxDoodle.prototype={setColor:function(t){this.style.color=t;var i=o.str2rgba(this.style.color),e=.299*i.r+.587*i.g+.114*i.b;this.style.color=170<e?"#000":"#fff",this.editor.textarea.style.color=this.style.color},initialize:function(){var t=this.parent_doodle,i=this.matrix;o.setArray(i,t.matrix),this._calc_size(),this.edit_height=this.size.height,this.initialized=!0,this._setAutoWidth(this.auto_width),this._calc()},afterUndoRedo:function(){var t=this.parent_doodle,i=this.matrix;o.setArray(i,t.matrix),this._calc_size(),this._calc(),this.actived&&this.resetOutline()},_calc_size:function(){var t=this.parent_doodle,i=this.points,e=Math.asin(1)/2,o=t.radius.a*Math.cos(e),s=t.radius.b*Math.sin(e);i[0].x=Math.floor(t.center.x-o+8),i[0].y=Math.floor(t.center.y-s+8),i[1].x=Math.floor(t.center.x+o-8),i[1].y=Math.floor(t.center.y+s-8),this.center.x=t.center.x,this.center.y=t.center.y,this.size.width=Math.max(20,i[1].x-i[0].x),this.size.height=Math.max(20,i[1].y-i[0].y)},_resetSize:function(){var t=this.matrix,i=Math.sqrt(t[0]*t[4]-t[1]*t[3])*this.drawer.zoom_scale,e=this.size.width,o=this.edit_height;this.editor.setBoxSize_scale(e,o,i),this.editor.render.height=this.size.height},active:function(){this._doActive(),this.editor.textarea.style.color=this.style.color},unactive:function(){this.callBase("unactive"),this.edit_height=Math.max(this.size.height,this.editor.cur_page.page_height)},editStart:function(){o.setArray(this.pre_matrix,this.matrix)},editFinish:function(){},editMove:function(){var t=this.parent_doodle,i=this.matrix;o.setArray(i,t.matrix),this._calc(),this.actived&&this.resetOutline()},editRotateScale:function(){var t=this.parent_doodle,i=this.matrix;o.setArray(i,t.matrix),this._calc(),this.actived&&this.resetOutline()},onTextInput:function(t){var i=this.editor.textarea,e=i.scrollHeight;i.offsetHeight!==e&&(i.style.height=e+"px")},draw_select:function(t,i){this.actived||this._draw_text(t)},draw:function(t){this.initialized?this.actived||this._draw_text(t):this._doDraw(t,null,this.style.color)},on_resize_region:function(){var t=this.editor.textarea;if(this._calc_size(),this._calc(),this._resetSize(),this.actived){this.editor.setBoxMatrix(this.editor_matrix);var i=t.scrollHeight;t.offsetHeight!==i&&(t.style.height=i+"px")}}},o.inherit(i._InnerTextboxDoodle,i._TextboxDoodle)}(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i){t._RectBlurDoodle=function(e){1===e.points.length&&e.points.push({x:e.points[0].x,y:e.points[0].y}),e.pen_width=2,e.region_points=i.genPoints(4),this.base(t.Type.RECT_BLUR,e),this._create_edit_region()},t._RectBlurDoodle.prototype={onRegionEdit:function(t,i){var e=i.x,o=i.y,s=this.points[0],n=this.points[1];switch(t){case 0:s.x=e,s.y=o;break;case 1:n.x=e,s.y=o;break;case 2:n.x=e,n.y=o;break;case 3:s.x=e,n.y=o}this._calc()},_calc:function(){var t=this.points,i=this.region_points;i[0].x=t[0].x,i[0].y=t[0].y,i[1].x=t[1].x,i[1].y=t[0].y,i[2].x=t[1].x,i[2].y=t[1].y,i[3].x=t[0].x,i[3].y=t[1].y,this._calc_1(this.points)},draw:function(t){var e=this.boundary,o=this.drawer.zoom_scale,s=this.drawer.bg_info.x,n=this.drawer.bg_info.y,a=Math.floor((e.left-s)*o),h=Math.floor((e.top-n)*o),r=Math.floor(e.width*o),_=Math.floor(e.height*o);0<r&&0<_&&i.stackBlurCanvasRGBA(t,a,h,r,_,Math.floor(this.drawer.style.blur_radius*this.drawer.zoom_scale))},draw_blur:function(t,e){var o=this.drawer.b_ctx;t.save(),t.setTransform(1,0,0,1,0,0),o.save(),o.setTransform(1,0,0,1,0,0);var s=this.boundary,n=this.drawer.zoom_scale,a=this.drawer.bg_info.x,h=this.drawer.bg_info.y,r=Math.floor((s.left-a)*n),_=Math.floor((s.top-h)*n),l=Math.floor(s.width*n),d=Math.floor(s.height*n);0<l&&0<d&&(o.drawImage(this.drawer.doodle_canvas,r,_,l,d,r,_,l,d),i.stackBlurCanvasRGBA(o,r,_,l,d,Math.floor(this.drawer.style.blur_radius*this.drawer.zoom_scale)),t.drawImage(this.drawer.blur_canvas,r,_,l,d,r,_,l,d)),t.restore(),o.restore(),t.strokeStyle="rgba(0, 0, 0, 0.6)",t.lineWidth=Math.floor(2*n),i.setLineDash(t,[4*n,4*n]),this._doDraw(t)},_doDraw:function(t,i){var e=this.points;t.save(),t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.lineTo(e[0].x,e[1].y),t.closePath(),i&&(t.fillStyle=i,t.fill()),t.stroke(),t.restore()},_doChooseDraw:function(t,i){this._doDraw(t,i)},draw_select:function(t){this.draw_blur(t,this.drawer.blur_canvas)},editPushPoint:function(t){this.points[1].x=t.x,this.points[1].y=t.y,this._calc()}},i.inherit(t._RectBlurDoodle,t._CommonDoodle)}(Diigo.Doodle,Diigo.$),function(t,i,e){t._CutDoodle=function(i){1===i.points.length&&i.points.push({x:i.points[0].x,y:i.points[0].y}),this.base(t.Type.CUT,i),this.pre_points=e.copyPoints(this.points),this.region_points=e.genPoints(8),this.dash_value=[3,3],this.resetScale(),this._create_edit_region(),this.__point_in__=!1},t._CutDoodle.prototype={setSize:function(t,i){var e=this.points[0],o=this.points[1];e.x<o.x?o.x=e.x+t:e.x=o.x+t,e.y<o.y?o.y=e.y+i:e.y=o.y+i,this._calc()},_size_callback:function(){var t=this.points,i=Math.abs(t[1].x-t[0].x),e=Math.abs(t[1].y-t[0].y),o=Math.min(t[0].x,t[1].x),s=Math.min(t[0].y,t[1].y),n=this.drawer.bg_info,a=n.x+n.width-o,h=n.y+n.height-s;this.drawer.style_callback("crop",{left:o,top:s,width:i,height:e,max_width:a,max_height:h})},checkPointIn:function(t,i){var e=this.boundary,o=t>=e.left+10&&t<=e.right-10&&i>=e.top+10&&i<=e.bottom+10;o&&!this.__point_in__?(this.__point_in__=!0,this.drawer.setCursor_name("cursor_move")):!o&&this.__point_in__&&(this.__point_in__=!1,this.drawer.setCursor_name("cursor_default"))},onRegionEdit:function(t,i){var e=i.x,o=i.y,s=this.points[0],n=this.points[1];switch(t){case 0:s.x=e,s.y=o;break;case 1:s.y=o;break;case 2:n.x=e,s.y=o;break;case 3:n.x=e;break;case 4:n.x=e,n.y=o;break;case 5:n.y=o;break;case 6:s.x=e,n.y=o;break;case 7:s.x=e}this._calc(),this._size_callback()},resetScale:function(){var t=Math.round(3*this.drawer.zoom_scale);this.dash_value[0]=t,this.dash_value[1]=t},_calc:function(){var t=this.points,i=this.region_points;i[0].x=t[0].x,i[0].y=t[0].y,i[1].x=Math.floor((t[0].x+t[1].x)/2),i[1].y=t[0].y,i[2].x=t[1].x,i[2].y=t[0].y,i[3].x=t[1].x,i[3].y=Math.floor((t[0].y+t[1].y)/2),i[4].x=t[1].x,i[4].y=t[1].y,i[5].x=Math.floor((t[0].x+t[1].x)/2),i[5].y=t[1].y,i[6].x=t[0].x,i[6].y=t[1].y,i[7].x=t[0].x,i[7].y=Math.floor((t[0].y+t[1].y)/2),this._calc_1(this.points)},editPushPoint:function(t){this.points[1].x=t.x,this.points[1].y=t.y,this._calc(),this._size_callback()},_create_edit_region:function(){for(var i=0;i<this.region_points.length;i++)this.edit_regions.push(new t.CircleRegion(this,i,this.region_points[i],7,"pointer"))},editMove:function(t,i){for(var e=0;e<this.points.length;e++)this.points[e].x=this.pre_points[e].x+t,this.points[e].y=this.pre_points[e].y+i;this._calc()},move:function(t,i){for(var e=0;e<this.points.length;e++)this.points[e].x+=t,this.points[e].y+=i;this._calc()},editStart:function(){e.setPoints(this.pre_points,this.points)},editFinish:function(){this._calc(),this._size_callback()},draw:function(t){var i=this.points;t.save(),e.setLineDash(t,this.dash_value),t.beginPath(),t.moveTo(i[0].x,i[0].y),t.lineTo(i[1].x,i[0].y),t.lineTo(i[1].x,i[1].y),t.lineTo(i[0].x,i[1].y),t.closePath(),t.save(),t.fillStyle="black",t.globalCompositeOperation="destination-out",t.fill(),t.restore(),t.strokeStyle="rgba(0, 128, 255, 0.9)",t.lineWidth=Math.floor(2/this.drawer.zoom_scale),t.stroke(),t.restore()},_doDraw:function(t){var i=this.points;t.beginPath(),t.moveTo(i[0].x,i[0].y),t.lineTo(i[1].x,i[0].y),t.lineTo(i[1].x,i[1].y),t.lineTo(i[0].x,i[1].y),t.closePath(),t.fill()}},e.inherit(t._CutDoodle,t._Doodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){var o=Math.PI*(10/180);t._CalloutDoodle=function(i){this.center={x:0,y:0},this.radius={a:0,b:0};var o=2*Math.PI*(60/180);this.a_info={angle:0,start:o,end:o,point:{x:0,y:0},border_point:{x:0,y:0}},this.r_point={x:0,y:0},i.region_number=4,i.pen_width=4,this.base(t.Type.CALLOUT,i),this._pre_info={rx:0,ry:0,ax:0,ay:0},this.fill_color=this.color,this.has_shadow=!0,this.child_textbox=t.create(t.Type.INNERTEXT,{points:e.copyPoints(this.points),drawer:this.drawer,editor:this.drawer.textbox_editor,parent_doodle:this,auto_width:!1})},t._CalloutDoodle.prototype={resetScale:function(){this.child_textbox.resetScale()},setFontName:function(t){this.child_textbox.setFontName(t)},setFontSize:function(t){this.child_textbox.setFontSize(t)},setPenWidth:function(){},setColor:function(t){this.color=t,this.highlight_color=this._calc_highlight_color(t),this.child_textbox.setColor(t)},getRegionUndoCommand:function(){return new i._DoodleCalloutCommand(this)},afterUndoRedo:function(){this._calc(),this._calc_a_info(),this._calc_r_point(),this.child_textbox.afterUndoRedo(),this.drawer._select_doodle(this)},initialize:function(){this.child_textbox.initialize(),this.initialized=!0},onRegionEdit:function(t,i){var e=this.points,o=this._calcBeforeMatrixPoint(this.matrix,i.x,i.y),s=o.x,n=o.y;if(0===t)e[0].x=s,e[0].y=n;else if(2===t)e[1].x=s,e[1].y=n;else if(1===t)e[0].y=n,e[1].x=s;else if(3===t)e[0].x=s,e[1].y=n;else if(4===t){var a=Math.min(e[0].x,e[1].x),h=Math.max(e[0].x,e[1].x),r=Math.min(e[0].y,e[1].y),_=Math.max(e[0].y,e[1].y);if(10<a-s||0<s-h||10<r-n||10<n-_)return this.a_info.point.x=s,this.a_info.point.y=n,this._calc_a_info(),void this._calc_r_point()}this._calc();var l=this._pre_info,d=Math.floor((s-this.center.x)/l.rx*l.ax),c=Math.floor((n-this.center.y)/l.ry*l.ay);this.a_info.point.x=d+this.center.x,this.a_info.point.y=c+this.center.y,this._calc_a_angle(d,c),this._calc_r_point(),this._calc_border_info(),this.child_textbox.on_resize_region(),this.drawer.edit_doodle.attachDoodle(this)},_calc_a_info:function(){var t=this.a_info.point.x,i=this.a_info.point.y,e=t-this.center.x,o=i-this.center.y,s=Math.sqrt(e*e+o*o),n=4*e/s,a=4*o/s;this.a_info.angle=Math.atan(this.radius.b/this.radius.a*Math.abs(e/o)),this.a_info.border_point.x=0==e?t:t+n,this.a_info.border_point.y=0==o?i:i+a,this._calc_a_angle(e,o)},_calc_border_info:function(){var t=this.a_info.point.x,i=this.a_info.point.y,e=t-this.center.x,o=i-this.center.y,s=Math.sqrt(e*e+o*o),n=4*e/s,a=4*o/s;this.a_info.border_point.x=0==e?t:t+n,this.a_info.border_point.y=0==o?i:i+a},_calc_a_angle:function(t,i){var e=this.a_info.angle;0<=t&&0<=i?e=Math.PI/2-e:0<=t&&i<=0?e=1.5*Math.PI+e:t<=0&&0<=i?e=Math.PI/2+e:t<=0&&i<=0&&(e=1.5*Math.PI-e),this.a_info.start=e+o,this.a_info.end=e-o},onRegionEditStart:function(t,i){var e=this._calcBeforeMatrixPoint(this.matrix,i.x,i.y),o=this._pre_info;o.rx=e.x-this.center.x,o.ry=e.y-this.center.y,o.ax=this.a_info.point.x-this.center.x,o.ay=this.a_info.point.y-this.center.y},onRegionEditFinish:function(){},_create_edit_region:function(){this.callBase("_create_edit_region"),this.region_points.push(this.r_point);var i=this.region_points.length-1;this.edit_regions.push(new t.CircleRegion(this,i,this.region_points[i]))},_calc:function(){var t=this.points,i=Math.min(t[0].x,t[1].x),e=Math.max(t[0].x,t[1].x),o=Math.min(t[0].y,t[1].y),s=Math.max(t[0].y,t[1].y);this.center.x=Math.floor((i+e)/2),this.center.y=Math.floor((o+s)/2),this.radius.a=Math.floor((e-i)/2),this.radius.b=Math.floor((s-o)/2),this.callBase("_calc"),this.initialized||(this.a_info.point.x=Math.floor(i+(e-i)/2*.5),this.a_info.point.y=Math.floor(s+(s-o)/2*.3),this._calc_a_info()),this._calc_r_point()},_calc_r_point:function(){var t=this.matrix,i=this.a_info.point.x,e=this.a_info.point.y;this.r_point.x=Math.floor(t[0]*i+t[1]*e+t[2]),this.r_point.y=Math.floor(t[3]*i+t[4]*e+t[5])},draw:function(t){t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),t.fillStyle=this.highlight_color,t.save(),t.shadowOffsetX=1,t.shadowOffsetY=2,t.shadowBlur=3,t.shadowColor="rgba(0, 0, 0, 0.5)",t.beginPath(),t.ellipse(this.center.x,this.center.y,this.radius.a+4,this.radius.b+4,0,this.a_info.start+.02,this.a_info.end-.02,0),t.lineTo(this.a_info.border_point.x,this.a_info.border_point.y),t.closePath(),t.fill(),t.restore(),t.fillStyle=this.color,t.beginPath(),t.ellipse(this.center.x,this.center.y,this.radius.a,this.radius.b,0,this.a_info.start,this.a_info.end,0),t.lineTo(this.a_info.point.x,this.a_info.point.y),t.closePath(),t.fill(),t.restore(),this.initialized&&this.child_textbox.draw(t)},_doDraw:function(t,i){t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),i&&(t.fillStyle=i),t.beginPath(),t.ellipse(this.center.x,this.center.y,this.radius.a,this.radius.b,0,this.a_info.start,this.a_info.end,0),t.lineTo(this.a_info.point.x,this.a_info.point.y),t.closePath(),i?t.fill():t.stroke(),t.restore()},_doChooseDraw:function(t,i){this._doDraw(t,i)},_doSelectDraw:function(t){},editPushPoint:function(t){this.points[1].x=t.x,this.points[1].y=t.y,this._calc()}},e.inherit(t._CalloutDoodle,t._MatrixDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){var o="Arial";t._ListDoodle=function(i){this.center=i.points[0];var o=t._ListDoodle.__LAST_INFO__;i.color=o.color,i.points=[{x:0,y:0},{x:0,y:0}],this.radius={a:o.radius.a,b:o.radius.b},this._calc_points(i.points),this.i_value=o.getValue(),this.i_type=o.i_type,this.i_str="",this._get_i_str();var s=e.str2rgba(i.color),n=.299*s.r+.587*s.g+.114*s.b;this.font_color=200<n?e.rgba2str(0,0,0,s.a):e.rgba2str(255,255,255,s.a),this.border_color=e.rgba2str(255,255,255,s.a),this.font="",this.base(t.Type.LIST,i),this._pre_rp={x:0,y:0}},t._ListDoodle.__LAST_INFO__={radius:{a:20*window.devicePixelRatio,b:20*window.devicePixelRatio},i_type:"number",i_value:1,color:"#000",cursor_cache:{},getValue:function(){return this.i_value++},getCursor:function(){var t=this.cursor_cache[this.i_value];return void 0===t&&(t=e.getListCursor(this.i_value),this.cursor_cache[this.i_value]=t),t},reset:function(){this.i_type="number",this.i_value=1,this.radius.a=20,this.radius.b=20}},t._ListDoodle.__WIDTH_CACHE__={w_table:{},h_table:{},get_w:function(t,i,e){var s=this.w_table[t];void 0===s&&(s={},this.w_table[t]=s);var n=s[i];return void 0===n&&(e.save(),e.font=i+"px "+o,n=e.measureText(t).width,e.restore(),s[i]=n),n},get_h:function(t){var i=this.h_table[t];return void 0===i&&(i=Math.floor(e.getFontInfo(t+"px "+o).height),this.h_table[t]=i),i}},t._ListDoodle.prototype={setPenWidth:function(){},setColor:function(t){this.color=t;var i=e.str2rgba(this.color),o=.299*i.r+.587*i.g+.114*i.b;this.font_color=200<o?e.rgba2str(0,0,0,i.a):e.rgba2str(255,255,255,i.a),this.border_color=e.rgba2str(255,255,255,i.a)},set_i_value:function(t){this.i_value=t,this._get_i_str(),this._calc_font(),this.drawer._paintEditLayer()},_get_i_str:function(){if("number"===this.i_type)this.i_str=this.i_value.toString()},_calc_font:function(){for(var i=Math.asin(1)/2,e=this.radius.a*Math.cos(i),s=this.radius.b*Math.sin(i),n=t._ListDoodle.__WIDTH_CACHE__,a=Math.floor(2*e),h=Math.floor(2*s),r=100,_=this.i_str,l=this.drawer.t_ctx;n.get_w(_,r,l)<a&&n.get_h(r)<h;)r*=2;function d(t,i,e){for(var o=Math.floor((i+t)/2),s="w"===e?a:h;;){if(i-o<=1)return o;var r="w"===e?n.get_w(_,o,l):n.get_h(o);if(s<r)i=o;else{if(!(r<s))return o;t=o}o=Math.floor((i+t)/2)}}n.get_w(_,r,l)>a&&(r=d(1,r,"w")),n.get_h(r)>h&&(r=d(1,r,"h")),this.font=r+"px "+o},_calc_points:function(t){var i=this.center,e=this.radius;t[0].x=i.x-e.a,t[0].y=i.y-e.b,t[1].x=i.x+e.a,t[1].y=i.y+e.b},onRegionEdit:function(t,i){var e=this.points;this._onRegionEdit(t,i,e);var o=Math.round(Math.abs(e[0].x-e[1].x)/2),s=Math.round(Math.abs(e[0].y-e[1].y)/2);this.radius.a=this.radius.b=Math.min(o,s),this._calc_points(this.points),this._calc(),this.drawer.edit_doodle.attachDoodle(this)},onRegionEditStart:function(t,i){this._pre_rp.x=i.x,this._pre_rp.y=i.y},onRegionEditFinish:function(i,e){var o=t._ListDoodle.__LAST_INFO__;o.radius.a=this.radius.a,o.radius.b=this.radius.b},_calc:function(){var t=this.points;this.center.x=Math.round((t[0].x+t[1].x)/2),this.center.y=Math.round((t[0].y+t[1].y)/2),this.radius.a=Math.round(Math.abs(t[0].x-t[1].x)/2),this.radius.b=Math.round(Math.abs(t[0].y-t[1].y)/2),this.callBase("_calc"),this._calc_font()},_doDraw:function(t,i){t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),e.drawEllipse(t,this.center.x,this.center.y,this.radius.a,this.radius.b,i),t.restore()},draw:function(t){var i=this.center.x,e=this.center.y,o=this.radius.a,s=this.radius.b;t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),t.save(),t.fillStyle=this.border_color,t.lineWidth=4,t.shadowColor="rgba(0, 0, 0, 0.4)",t.shadowOffsetX=0,t.shadowOffsetY=2,t.shadowBlur=4,t.beginPath(),t.ellipse(i,e,o+4,s+4,0,0,2*Math.PI,0),t.closePath(),t.fill(),t.restore(),t.fillStyle=this.color,t.beginPath(),t.ellipse(i,e,o,s,0,0,2*Math.PI,0),t.closePath(),t.fill(),t.font=this.font,t.fillStyle=this.font_color,t.textAlign="center",t.textBaseline="middle",t.fillText(this.i_str,this.center.x,this.center.y),t.restore()},_doChooseDraw:function(t,i){this._doDraw(t,i)},_doSelectDraw:function(t){},editPushPoint:function(t){}},e.inherit(t._ListDoodle,t._MatrixDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){t._BezierArrowDoodle=function(i){1===i.points.length?i.points.push({x:0,y:0},{x:0,y:0},{x:i.points[0].x,y:i.points[0].y}):2===i.points.length&&i.points.splice(1,0,{x:0,y:0},{x:0,y:0}),this.rotate_point={x:0,y:0},this.arrow_info={idx:0,pos:{}},this.base(t.Type.BEZIER_ARROW,i),this.region_points=this.points,this._create_edit_region()},t._BezierArrowDoodle.prototype={setPenWidth:function(t){this.callBase("setPenWidth",t),this._calc_arrow()},_calc:function(){this._calc_1(this.points),this._calc_arrow()},draw:function(t){var i=this.drawer.t_ctx,e=this.drawer.bg_info;i.save(),i.fillStyle=this.color,i.strokeStyle=this.color,i.lineWidth=this.pen_width,i.clearRect(e.x,e.y,e.width,e.height),this._doDraw(i),i.restore(),t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(i.canvas,0,0),t.restore()},_calc_arrow:function(){var t=this.points,i=5*this.pen_width;this.arrow_info.idx=e.getPTPRange(t[0],t[3])>i?1:0,this.arrow_info.pos=e.calcArrow(t[2].x,t[2].y,t[3].x,t[3].y,i)},_doDraw:function(t,i){var e=this.points,o=this.arrow_info,s=o.pos,n=0===o.idx;t.beginPath(),n?(t.beginPath(),t.moveTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.closePath(),t.fill()):(t.moveTo(e[0].x,e[0].y),t.bezierCurveTo(e[1].x,e[1].y,e[2].x,e[2].y,o.pos.cx,o.pos.cy),i?(t.lineTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.lineTo(s.cx,s.cy),t.stroke()):(t.stroke(),t.closePath(),t.beginPath(),t.moveTo(s.ax,s.ay),t.lineTo(s.dx,s.dy),t.lineTo(s.bx,s.by),t.closePath(),t.save(),t.globalCompositeOperation="destination-out",t.fillStyle="black",t.fill(),t.restore(),t.fill()))},_doSelectDraw:function(t){var i=this.points;t.save(),t.lineWidth=2,e.setLineDash(t,[8,5]),t.strokeStyle=this.highlight_color,t.shadowBlur=3,t.shadowColor="rgba(0,0,0,0.4)",t.shadowOffsetX=0,t.shadowOffsetY=1,t.beginPath(),t.moveTo(i[0].x,i[0].y),t.lineTo(i[1].x,i[1].y),t.lineTo(i[2].x,i[2].y),t.lineTo(i[3].x,i[3].y),t.stroke(),t.closePath(),t.restore(),this._doDraw(t,!0)},_doChooseDraw:function(t,i){this._doDraw(t,!1)},editPushPoint:function(t){var i=this.points;i[3].x=t.x,i[3].y=t.y;var e=Math.floor((i[3].x-i[0].x)/3),o=Math.floor((i[3].y-i[0].y)/3);i[1].x=i[0].x+e,i[1].y=i[0].y+o,i[2].x=i[1].x+e,i[2].y=i[1].y+o,this._calc()},getRegionUndoCommand:function(){return new i._DoodlePointsCommand(this)},onRegionEdit:function(t,i){this.points[t].x=i.x,this.points[t].y=i.y,this._calc(),this.drawer.edit_doodle.attachDoodle(this)},onRegionEditFinish:function(t,i){this.drawer.edit_doodle.attachDoodle(this)}},e.inherit(t._BezierArrowDoodle,t._CommonDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){t._AnnotationDoodle=function(t,i){this.base(t,i),this.matrix=null==i.matrix?[1,0,0,0,1,0,0,0,0]:i.matrix,this.pre_matrix=e.copyArray(this.matrix),this.pre_points=e.copyPoints(this.points),this.rotate_point={x:0,y:0},this.svg_width=i.svg_info.width,this.svg_height=i.svg_info.height,this.svg_shapes=i.svg_info.shapes,this._pre_svg(),this.pre_svg_shapes=this._copy_svg_shapes(),this.region_points=e.genPoints(8),this._calc(),this._create_edit_region()},t._AnnotationDoodle.prototype={_copy_svg_shapes:function(){for(var t=[],i=0;i<this.svg_shapes.length;i++){for(var o=this.svg_shapes[i],s={type:o.type,cmd_arr:[]},n=0;n<o.cmd_arr.length;n++){var a=o.cmd_arr[n];s.cmd_arr.push({command:a.command,points:e.copyArray(a.points)})}t.push(s)}return t},_pre_svg:function(){for(var t=0;t<this.svg_shapes.length;t++){var i=this.svg_shapes[t];"path"===i.type&&(i.cmd_arr=e.parseSVGPath(i.data))}},_create_edit_region:function(){for(var i=["nwse-resize","ns-resize","nesw-resize","ew-resize","nwse-resize","ns-resize","nesw-resize","ew-resize"],e=0;e<this.region_points.length;e++)this.edit_regions.push(new t.CircleRegion(this,e,this.region_points[e],7,i[e]))},onRegionEdit:function(t,i){var e=i.x,o=i.y,s=this.points[0],n=this.points[1];switch(t){case 0:s.x=e,s.y=o;break;case 1:s.y=o;break;case 2:n.x=e,s.y=o;break;case 3:n.x=e;break;case 4:n.x=e,n.y=o;break;case 5:n.y=o;break;case 6:s.x=e,n.y=o;break;case 7:s.x=e}this._calc()},_calc:function(){var t=this.points,i=this.region_points;i[0].x=t[0].x,i[0].y=t[0].y,i[1].x=Math.floor((t[0].x+t[1].x)/2),i[1].y=t[0].y,i[2].x=t[1].x,i[2].y=t[0].y,i[3].x=t[1].x,i[3].y=Math.floor((t[0].y+t[1].y)/2),i[4].x=t[1].x,i[4].y=t[1].y,i[5].x=Math.floor((t[0].x+t[1].x)/2),i[5].y=t[1].y,i[6].x=t[0].x,i[6].y=t[1].y,i[7].x=t[0].x,i[7].y=Math.floor((t[0].y+t[1].y)/2),this._calc_1(this.points),this._calc_svg();var e=this.boundary;this.rotate_point.x=Math.floor(e.left+e.width/2),this.rotate_point.y=e.top-20},_calc_svg:function(){for(var t,i,e,o,s,n,a=this.points,h=Math.min(a[0].x,a[1].x),r=Math.min(a[0].y,a[1].y),_=Math.abs(a[0].x-a[1].x),l=Math.abs(a[0].y-a[1].y),d=_/this.svg_width,c=l/this.svg_height,u=0;u<this.svg_shapes.length;u++)if(t=this.svg_shapes[u],o=this.pre_svg_shapes[u],"path"===t.type){i=t.cmd_arr,s=o.cmd_arr;for(var f=0;f<i.length;f++){e=i[f].points,n=s[f].points;for(var p=0;p<e.length;p+=2)e[p]=h+n[p]*d,e[p+1]=r+n[p+1]*c}}},_draw_path:function(t,i){t.save(),t.beginPath();for(var e,o,s=i.cmd_arr,n=0;n<s.length;n++)switch(o=(e=s[n]).points,e.command){case"M":t.moveTo(o[0],o[1]);break;case"C":t.bezierCurveTo(o[0],o[1],o[2],o[3],o[4],o[5]);break;case"Q":t.quadraticCurveTo(o[0],o[1],o[2],o[3]);break;case"L":t.lineTo(o[0],o[1]);break;case"Z":t.closePath()}t.fill(),t.restore()},_doDraw:function(t,i,e){t.fillStyle=i;for(var o=0;o<this.svg_shapes.length;o++){var s=this.svg_shapes[o];if("path"===s.type)this._draw_path(t,s)}},draw_select:function(t){t.save(),t.restore()},draw:function(t){var i=this.points;t.save(),t.lineWidth=3,t.lineCap="round",t.lineJoin="round",t.fillStyle=this.color,this._doDraw(t),this.initialized||(t.strokeStyle="black",t.beginPath(),t.moveTo(i[0].x,i[0].y),t.lineTo(i[1].x,i[0].y),t.lineTo(i[1].x,i[1].y),t.lineTo(i[0].x,i[1].y),t.closePath(),t.stroke()),t.restore()},editStart:function(){e.setPoints(this.pre_points,this.points)},editMove:function(t,i){for(var e=0;e<this.points.length;e++)this.points[e].x=this.pre_points[e].x+t,this.points[e].y=this.pre_points[e].y+i;this._calc()},editRotateScale:function(t,i,e,o){for(var s=0;s<this.points.length;s++){var n=this.pre_points[s].x-t.x,a=this.pre_points[s].y-t.y;this.points[s].x=Math.round(n+t.x),this.points[s].y=Math.round(a+t.y),this.points[s].x=Math.round(n*Math.cos(i)-a*Math.sin(i)+t.x),this.points[s].y=Math.round(n*Math.sin(i)+a*Math.cos(i)+t.y)}!0!==o&&this._calc()},rotateScale:function(t,i,o){e.setPoints(this.pre_points,this.points),this.editRotateScale(t,i,o)},editPushPoint:function(t){var i,e,o=this.points[0],s=this.points[1],n=t.x-o.x,a=Math.abs(n),h=t.y-o.y,r=Math.abs(h),_=a/this.svg_width,l=r/this.svg_height,d=this.svg_width/this.svg_height;l<_?i=(e=r)*d:e=(i=a)/d,s.x=o.x+Math.floor(0<n?i:-i),s.y=o.y+Math.floor(0<h?e:-e),this._calc()}},e.inherit(t._AnnotationDoodle,t._Doodle),t._Annotation_A_Doodle=function(i){i.svg_info={width:351.712,height:561.438,shapes:[{type:"path",data:"M333.184,374.484c-11.569,17.688-28.387,33.211-48.997,44.933c31.007,68.849,60.356,136.001,59.616,141.905c0,0.081-0.039,0.081-0.06,0.161L277.16,423.179c-0.81,0.404-1.548,0.891-2.367,1.253c23.594,49.353,46.428,96.923,60.071,124.311c-14.724-24.595-40.957-72.452-66.706-121.235c-13.298,5.662-26.84,9.465-40.189,11.124c-49.877,6.311-96.65-14.281-114.895-54.802c-10.205-22.735-0.242-32.667,15.908-57.181L89.398,162.948c-24.452,1.975-51.909-15.158-68.576-29.973c39.715,11.7,76.577,2.669,101.19-7.718c3.49,5.827,13.341,22.33,14.583,24.858c15.667-6.704,27.64-14.622,35.589-21.014l-0.042-0.081l-7.322-28.772c17.072-13.229,30.471-28.409,38.016-43.164c-0.181,18.983-3.438,43.286-15.168,56.846c0,0,65.674,100.017,92.795,142.089c30.359,3.458,53.105,0.628,63.682,24.089C357.74,310.327,352.379,345.033,333.184,374.484z M174.703,133.701c-8.223,6.514-20.298,14.412-36.023,21.147l89.167,209.149c7.059-2.326,14.018-5.036,20.429-8.464c13.724-7.353,24.716-16.979,32.463-27.903L174.703,133.701z M329.22,358.949l-45.001-27.314c-8.174,11.164-19.499,20.975-33.495,28.468c-6.745,3.6-14.067,6.431-21.491,8.868l-1.021,53.196l-0.021,0.404c11.872-2.59,23.887-6.514,35.821-11.853c27.893-12.528,50.484-30.795,65.411-51.019L329.22,358.949z M133.776,114.123c-23.767,12.408-71.084,30.26-121.235,10.941c-4.207-3.407-7.626-7.392-9.769-12.176c-2.316-5.208-3.116-10.891-2.639-16.818C2.449,68.886,33,36.121,77.598,16.076c44.609-20.003,89.4-21.055,111.234-4.743c4.795,3.582,8.464,7.948,10.822,13.158c2.337,5.216,3.144,10.892,2.639,16.848c0.081,0.92,0.122,2.063,0.182,3.073C195.253,68.2,167.614,96.466,133.776,114.123z"}]},this.base(t.Type.ANNOTATION_A,i)},e.inherit(t._Annotation_A_Doodle,t._AnnotationDoodle),t._Annotation_B_Doodle=function(i){i.svg_info={width:412.827,height:435.695,shapes:[{type:"path",data:"M121.917,0.016c-8.358-0.696-33.496,20.935-25.586,54.895c7.908,33.959,38.146,65.593,40.938,83.737c2.791,18.143,2.791,37.216-25.122,40.007c-27.912,2.792-46.056-2.791-65.129-3.257c-19.073-0.465-46.056,10.7-46.986,33.496c-0.93,22.794,18.609,32.564,18.609,32.564S4.219,253.553,5.15,274.487c0.93,20.935,17.213,31.634,17.213,31.634s-11.629,28.843-1.861,41.404c9.77,12.56,21.4,18.143,21.4,18.143s-2.791,27.912,8.374,39.078c11.165,11.165,33.293,36.354,134.91,20.003c27.748-4.465,75.363-14.422,75.363-14.422s54.428-141.139,54.428-187.478c0-0.466-21.918-23.766-31.168-43.729c-8.84-19.073-38.893-48.101-73.969-72.572C169.833,78.636,127.499,0.481,121.917,0.016z"},{type:"path",data:"M330.329,225.177c0,0-32.292,147.129-53.964,174.453c-5.38,6.782,0.466,24.19,6.978,26.981c6.513,2.791,37.217,13.026,55.36,7.444c18.143-5.583,56.29-83.737,60.012-103.741c3.721-20.005,18.143-84.668,13.026-98.159C406.622,218.663,333.585,214.476,330.329,225.177z"}]},this.base(t.Type.ANNOTATION_B,i)},e.inherit(t._Annotation_B_Doodle,t._AnnotationDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){t._ImageDoodle=function(i){this.img=i.image,this.img_width=i.width,this.img_height=i.height,this.img_info={w:0,h:0},i.region_number=4,this.base(t.Type.IMAGE,i),this.choose_type="full"===i.choose_type?1:0},t._ImageDoodle.prototype={_onRegionEdit:function(t,i,e){var o=this._calcBeforeMatrixPoint(this.matrix,i.x,i.y),s=o.x,n=(o.y,this.points[0]),a=this.points[1],h=this.img_width/this.img_height;switch(t){case 0:n.x=s,n.y=parseInt(a.y-(a.x-o.x)/h);break;case 1:a.x=s,n.y=parseInt(a.y-(o.x-n.x)/h);break;case 2:a.x=s,a.y=parseInt((o.x-n.x)/h+n.y);break;case 3:n.x=s,a.y=parseInt((a.x-o.x)/h+n.y)}},_calc_info:function(){var t=this.points,i=Math.abs(t[0].x-t[1].x),e=Math.abs(t[0].y-t[1].y);this.img_info.w=i,this.img_info.h=e},_calc:function(){this.callBase("_calc"),this._calc_info()},_doDraw:function(t,i){var e=this.points;t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),t.beginPath(),t.moveTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[0].y),t.lineTo(e[1].x,e[1].y),t.lineTo(e[0].x,e[1].y),t.closePath(),null!==i&&(t.fillStyle=i,t.fill()),t.stroke(),t.restore()},draw_select:function(t){t.save(),e.setLineDash(t,[4,4]),t.strokeStyle="rgba(0, 0, 0, 0.6)",t.lineWidth=2,this._doDraw(t,null),t.restore(),this.draw(t)},draw_choose:function(t,i){var o=e.int2color(i);if(0!==this.choose_type||this.selected)t.strokeStyle=o,t.fillStyle=o,t.lineWidth=Math.round(1.5*this.pen_width),this._doChooseDraw(t,o);else{var s=this.drawer.t_ctx,n=this.drawer.bg_info;s.save(),s.fillStyle=o,s.fillRect(n.x,n.y,n.width,n.height),s.globalCompositeOperation="destination-in",this.draw(s),s.restore(),t.save(),t.setTransform(1,0,0,1,0,0),t.drawImage(s.canvas,0,0),t.restore()}},draw:function(t){var i=this.points;t.save(),t.transform(this.matrix[0],this.matrix[3],this.matrix[1],this.matrix[4],this.matrix[2],this.matrix[5]),t.drawImage(this.img,0,0,this.img_width,this.img_height,i[0].x,i[0].y,this.img_info.w,this.img_info.h),t.restore()},editPushPoint:function(t){var i,e,o=this.points[0],s=this.points[1],n=t.x-o.x,a=Math.abs(n),h=t.y-o.y,r=Math.abs(h),_=a/this.img_width,l=r/this.img_height,d=this.img_width/this.img_height;l<_?i=(e=r)*d:e=(i=a)/d,s.x=o.x+Math.floor(0<n?i:-i),s.y=o.y+Math.floor(0<h?e:-e),this._calc()}},e.inherit(t._ImageDoodle,t._MatrixDoodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i){t._Command=function(){},t._Command.prototype={undo:function(){throw"abstract method"},redo:function(){throw"abstract method"},toString:function(){return"undo-redo-command"},finish:function(){}},t._CombineCommand=function(){this.cmd_array=[]},t._CombineCommand.prototype={add:function(t){this.cmd_array.push(t)},undo:function(){for(var t=this.cmd_array.length-1;0<=t;t--)this.cmd_array[t].undo()},redo:function(){for(var t=0;t<this.cmd_array.length;t++)this.cmd_array[t].redo()},toString:function(){return this.cmd_array.join(",")},finish:function(){for(var t=this.cmd_array.length-1;0<=t;t--)this.cmd_array[t].finish()}},i.inherit(t._CombineCommand,t._Command),t._UndoRedoManager=function(t){this.drawer=t,this.cmd_array=[],this.cmd_index=-1,this.cmd_size=0,this.MAX_NUM=99999999},t._UndoRedoManager.prototype={add:function(t){this.cmd_index+1<this.MAX_NUM?(this.cmd_index++,this.cmd_array[this.cmd_index]=t,this.cmd_size=this.cmd_index+1):(this.cmd_array.shift(),this.cmd_array.push(t)),this.drawer._ur_back()},undo:function(){0<=this.cmd_index&&(this.cmd_array[this.cmd_index--].undo(),this.drawer.paint(),this.drawer._ur_back())},canUndo:function(){return 0<=this.cmd_index},canRedo:function(){return this.cmd_index+1<this.cmd_size},redo:function(){this.cmd_index+1<this.cmd_size&&(this.cmd_array[++this.cmd_index].redo(),this.drawer.paint(),this.drawer._ur_back())},reset:function(){this.cmd_index=-1,this.cmd_size=0,this.cmd_array.length=0,this.drawer._ur_back()},clear:function(){this.reset()}},t._DoodleCalloutCommand=function(t){this.doodle=t,this.ps=i.copyPoints(t.points),this.cs=i.copyPoints(this.ps),this.pa={x:t.a_info.point.x,y:t.a_info.point.y},this.ca={x:0,y:0}},t._DoodleCalloutCommand.prototype={_v:function(t,e){i.setPoints(this.doodle.points,t),this.doodle.a_info.point.x=e.x,this.doodle.a_info.point.y=e.y,this.doodle.afterUndoRedo()},undo:function(){this._v(this.ps,this.pa)},redo:function(){this._v(this.cs,this.ca)},finish:function(){i.setPoints(this.cs,this.doodle.points),this.ca.x=this.doodle.a_info.point.x,this.ca.y=this.doodle.a_info.point.y}},i.inherit(t._DoodleCalloutCommand,t._Command),t._DoodleTextCommand=function(t,i,e){this.doodle=t,this.ps=i,this.cs=e},t._DoodleTextCommand.prototype={_v:function(t){this.doodle.setURText(t),this.doodle.afterUndoRedo()},undo:function(){this._v(this.ps)},redo:function(){this._v(this.cs)}},i.inherit(t._DoodleTextCommand,t._Command),t._CropCommand=function(t){this.drawer=t;var i=this.drawer.bg_info;this.ps={x:i.x,y:i.y,w:i.width,h:i.height},this.cs=null},t._CropCommand.prototype={_v:function(t){this.drawer.set_bg_info(t)},undo:function(){this._v(this.ps)},redo:function(){this._v(this.cs)},finish:function(){var t=this.drawer.bg_info;this.cs={x:t.x,y:t.y,w:t.width,h:t.height}}},i.inherit(t._CropCommand,t._Command),t._SizeCommand=function(t){this.drawer=t;var i=this.drawer.bg_info;this.img=document.createElement("canvas"),this.ps={x:i.x,y:i.y,width:i.width,height:i.height},this.ds=[],this.cs=null,this._init()},t._SizeCommand.prototype={_init:function(){var t=this.img.getContext("2d");this.img.width=this.drawer.image_canvas.width,this.img.height=this.drawer.image_canvas.height,t.drawImage(this.drawer.image_canvas,0,0),[].push.apply(this.ds,this.drawer.page.doodle_array)},undo:function(){this.drawer._set_image_size_undo(this.img,this.ps,this.ds)},redo:function(){this.drawer._set_image_size_redo(this.cs.width,this.cs.height)},finish:function(){var t=this.drawer.bg_info;this.cs={x:t.x,y:t.y,width:t.width,height:t.height}}},i.inherit(t._SizeCommand,t._Command)}(Diigo.UndoRedo,Diigo.$),function(t,i){t._DoodleColorCommand=function(t,i,e){this.doodle=t,this.ps=i,this.cs=e},t._DoodleColorCommand.prototype={undo:function(){this.doodle.setColor(this.ps)},redo:function(){this.doodle.setColor(this.cs)}},i.inherit(t._DoodleColorCommand,t._Command),t._DoodleWidthCommand=function(t,i,e){this.doodle=t,this.ps=i,this.cs=e},t._DoodleWidthCommand.prototype={undo:function(){this.doodle.setPenWidth(this.ps)},redo:function(){this.doodle.setPenWidth(this.cs)}},i.inherit(t._DoodleWidthCommand,t._Command),t._DoodleNewCommand=function(t){this.doodle=t},t._DoodleNewCommand.prototype={undo:function(){this.doodle.drawer._removeDoodle(this.doodle)},redo:function(){this.doodle.drawer._ur_insert(this.doodle)}},i.inherit(t._DoodleNewCommand,t._Command),t._DoodleDelCommand=function(t){this.doodle=t},t._DoodleDelCommand.prototype={undo:function(){this.doodle.drawer._ur_insert(this.doodle)},redo:function(){this.doodle.drawer._removeDoodle(this.doodle)},toString:function(){return"doodle-command"}},i.inherit(t._DoodleDelCommand,t._Command),t._DoodlePointsCommand=function(t,e,o){this.doodle=t,this.ps=e||i.copyPoints(t.points),this.cs=o||i.copyPoints(this.ps)},t._DoodlePointsCommand.prototype={undo:function(){i.setPoints(this.doodle.points,this.ps),this.doodle.afterUndoRedo()},redo:function(){i.setPoints(this.doodle.points,this.cs),this.doodle.afterUndoRedo()},finish:function(){i.setPoints(this.cs,this.doodle.points)}},i.inherit(t._DoodlePointsCommand,t._Command),t._DoodleMatrixCommand=function(t,e,o){this.doodle=t,this.ps=e||i.copyArray(t.matrix),this.cs=o||i.copyArray(this.ps)},t._DoodleMatrixCommand.prototype={undo:function(){i.setArray(this.doodle.matrix,this.ps),this.doodle.afterUndoRedo()},redo:function(){i.setArray(this.doodle.matrix,this.cs),this.doodle.afterUndoRedo()},finish:function(){i.setArray(this.cs,this.doodle.matrix)}},i.inherit(t._DoodleMatrixCommand,t._Command)}(Diigo.UndoRedo,Diigo.$),function(t,i,e){function o(t,i){var o=e.str2rgba(t);return o.a=i,"rgba("+o.r+","+o.g+","+o.b+","+o.a+")"}e.extend(t._Drawer.prototype,{_check_region_mouse_down:function(t){var i=this.__pre_mouse_enter_region__;return null!==i&&(i.onMouseDown(t),this.__tmp_undo_command__=i.doodle.getRegionUndoCommand(i),!0)},_pointChooseDoodle:function(t){var i=this.page.doodle_array,o=this.c_ctx.getImageData(t.ox,t.oy,1,1).data;if(o[3]<10)return null;var s=e.color2int(o);return s===i.length?this.cut_doodle?this.cut_doodle:null:0<=s&&i[s]?i[s]:null},_getEventPoint:function(t){null===this.out_pos&&(this.out_pos=e.getDomPosition(this.out_container));var i={x:t.pageX,y:t.pageY},o=this.zoom_scale,s=this.bg_info;return i.sx=i.x,i.sy=i.y,i.cx=i.x-this.out_pos.left,i.cy=i.y-this.out_pos.top,i.ox=(i.cx-this.container.offsetLeft+this.out_container.scrollLeft)*this.dpr,i.oy=(i.cy-this.container.offsetTop+this.out_container.scrollTop)*this.dpr,i.x=Math.floor(i.ox/o+s.x),i.y=Math.floor(i.oy/o+s.y),i},_mouse_up_handler:function(t){if(this.__left_mouse_db_down__)return this._mouse_double_down(),this.__left_mouse_db_down__=!1,void(this.__left_mouse_down__=!1);if(this.__left_mouse_down__){this.__left_mouse_down__=!1;var i=this._getEventPoint(t);this._mouse_up(i),this._select_back(),e.delMouseEvent(window,this.__saved_handler.mouse_move),e.delMouseEvent(window,this.__saved_handler.mouse_up),e.stopEvent(t)}},_check_region_mouse_in_out:function(t){var i=this.__pre_mouse_enter_region__,e=null,o=this.page.doodle_array;if(this.has_selected_doodle){if(null!==this.cut_doodle)e=a(this.cut_doodle,t,this.zoom_scale);else if(null===(e=a(this.edit_doodle,t,this.zoom_scale)))for(var s=0;s<o.length;s++){var n=a(o[s],t,this.zoom_scale);if(null!==n){e=n;break}}e!==i&&(null!==i&&(i.onMouseOut(),this._paintEditLayer()),null!==e?(e.onMouseIn(),this.setCursor_name(e.cursor),this._paintEditLayer()):2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor),this.__pre_mouse_enter_region__=e)}function a(t,i,e){for(var o=0;o<t.edit_regions.length;o++)if(t.edit_regions[o].isPointIn(i,e))return t.edit_regions[o];return null}},_mouse_move_handler:function(t){if(this.__left_mouse_down__){var i=this._getEventPoint(t),o=this.__pre_mouse_enter_region__;null!==o?(o.onMouseMove(i),this._adjust_scroll(i.x,i.y),this._paintEditLayer()):10<e.getPTPRange(this.__mouse_down_point__,i)&&this._mouse_move(i),e.stopEvent(t)}},_region_handler:function(i){var e=this._getEventPoint(i);if(!this.__left_mouse_down__&&(this._check_region_mouse_in_out(e),null===this.__pre_mouse_enter_region__)){var o=this._pointChooseDoodle(e);null!==o&&this.style.brush_type!==t.Type.RECT_BLUR&&o.type===t.Type.RECT_BLUR&&(o=null),null!==o&&this.__hover_doodle__!==o?(this.__hover_doodle__=o,this.setCursor_name("cursor_move")):null===o&&null!==this.__hover_doodle__&&(this.__hover_doodle__=null,2===this.cursor_type?this.setCursor(this.default_cursor):this.setCursor_name(this.default_cursor))}},_mouse_down_handler:function(t){if(!this.__left_mouse_down__&&0===t.button){this.__left_mouse_down__=!0,this.__left_mouse_db_down__=!1;var i=this._getEventPoint(t);this.__mouse_down_point__=i,1===this.__mouse_down_time__&&e.getPTPRange(this.__pre_point__,i)<10?(this.__mouse_down_time__=0,null!==this.__mdt_timeout__&&(window.clearTimeout(this.__mdt_timeout__),this.__mdt_timeout__=null),this.__left_mouse_db_down__=!0):(this.__pre_point__=i,this.__mouse_down_time__++,this.__mdt_timeout__=window.setTimeout(this.__mdt_delegate__,450),this._mouse_down(i)),this.__saved_handler.mouse_move=e.addMouseEvent(window,"mousemove",this.__cmv_handler),this.__saved_handler.mouse_up=e.addMouseEvent(window,"mouseup",this.__cmu_handler),e.stopEvent(t)}},initEvent:function(){this.__left_mouse_down__=!1,this.__left_mouse_db_down__=!1,this.__draw_point__=!1,this.__hover_doodle__=null,this.__cmv_handler=e.createDelegate(this,this._mouse_move_handler),this.__cmu_handler=e.createDelegate(this,this._mouse_up_handler),this.__saved_handler={mouse_move:null,mouse_up:null},this.__mouse_down_time__=0,this.__mdt_timeout__=null,this.__mdt_delegate__=e.createDelegate(this,(function(){this.__mouse_down_time__=0,this.__mdt_timeout__=null,this.__left_mouse_db_down__=!1})),e.addMouseEvent(this.edit_canvas,"mousedown",e.createDelegate(this,this._mouse_down_handler)),e.addEvent(this.edit_canvas,"mousemove",e.createDelegate(this,this._region_handler)),this.__pre_point__={x:0,y:0},this.$list_input.attr({min:1,max:999999}).on("mousedown",(function(t){t.stopPropagation()})).on("keypress",(function(t){(t.keyCode<47||58<t.keyCode)&&t.preventDefault()})).on("input",e.createDelegate(this,this._list_input_handler)).data("doodle",null),e.addEvent(window,"resize",e.createDelegate(this,this._on_resize))},_on_resize:function(){var t=this.out_container.offsetHeight,i=this.container.offsetHeight;this.container.style.top=i+40<t?"40px":"0px"},_list_input_handler:function(){var t=this.$list_input.data("doodle"),i=Number(this.$list_input.val());(i<1||999999<i)&&(i=this.$list_input.data("pre_value")),t.set_i_value(i)},_show_list_dialog:function(t){var i=this.$list_input,e=this.$list_dialog,o=i.data("doodle");i.data("doodle",t),i.data("pre_value",t.i_value),i.val(t.i_value);var s=t.boundary;for(var n in s)s[n]=s[n]/window.devicePixelRatio;var a=this.bg_info.x,h=this.bg_info.y,r=this.zoom_scale,_=Math.round((s.left+(s.width-e.innerWidth()/r)/2-a)*r),l=Math.round((s.bottom-h)*r)+15;null===o?e.css({left:_,top:l}).fadeIn(200,(function(){i.focus()})):e.animate({left:_,top:l},200)},_hide_list_dialog:function(){null!==this.$list_input.data("doodle")&&(this.$list_dialog.hide(),this.$list_input.data("doodle",null)),this.style_callback("mousedown")},hideListDialog:function(){null!==this.$list_input.data("doodle")&&(this.$list_dialog.hide(),this.$list_input.data("doodle",null))},_mouse_double_down:function(){var i=this.__hover_doodle__;if(null!==i){var e=t.Type;i.type===e.LIST?this._show_list_dialog(i):i.type===e.TEXT?(this.cur_textbox=i,this.activeTextbox()):i.type===e.CALLOUT&&(this.cur_textbox=i.child_textbox,this.activeInnerTextbox())}},_mouse_down:function(i){this._hide_list_dialog();var e=t.Type,o=this.style.brush_type;if(!this._check_region_mouse_down(i)){var s=null,n=this.page.doodle_array;if(null===this.cur_textbox||(this.unactiveTextbox(),this.paint(),o!==e.CALLOUT&&o!==e.TEXT)){this.temp_doodle=null;var a=this.has_selected_doodle?function(){for(var t=0;t<n.length;t++)if(n[t].selected)return n[t];return null}():null,h=this.__hover_doodle__;if(null===h&&o===e.LIST&&null===a){var r=t.create(e.LIST,{points:[this.__pre_point__],drawer:this});this.insertDoodle(r),this.default_cursor=t._ListDoodle.__LAST_INFO__.getCursor(),this.setCursor_name("cursor_move"),h=this.__hover_doodle__=r}else null===h&&o===e.TEXT&&null===a&&(this.temp_doodle=t.create(e.TEXT,{points:[this.__pre_point__],drawer:this}));if(null!==h){for(var _=0;_<n.length;_++)!0===n[_].selected&&(s=n[_]),n[_].selected=!1,n[_].setRegionDisabled(!0);h.selected=!0,this.has_selected_doodle=!0,this.edit_doodle.attachDoodle(h),this.edit_doodle.editStart(i),null!==this.cut_doodle?this.cut_doodle.editStart():(this.__tmp_undo_command__=h.getMoveUndoCommand(),h.editStart()),this._paintDoodleLayer(),this._paintEditLayer(),h.type!==e.RECT_BLUR||null!==s&&s.type===e.RECT_BLUR||this._prepare_for_blur()}else null===this.temp_doodle&&(this.style.brush_type===e.CURVE&&!1===this.has_selected_doodle?this.__draw_point__=!0:this.__draw_point__=!1,this._select_nothing(),this.edit_doodle.attachNothing(),this._paintDoodleLayer())}}},_move_doodle_to_top:function(t){var i=this.page.doodle_array,e=i.indexOf(t);0<=e&&(i.splice(e,1),i.unshift(t))},_mouse_up:function(i){var s=this.__pre_mouse_enter_region__,n=t.Type,a=t._ListDoodle.__LAST_INFO__;if(null!==s)return s.onMouseUp(i),s.is_changed&&(null!==this.__tmp_undo_command__&&(this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null),this.paint()),void(this.__pre_mouse_enter_region__=null);var h=this.__hover_doodle__;if(null!==h)return this.edit_doodle.editFinish(i),h.editFinish(),this._move_doodle_to_top(h),null!==this.__tmp_undo_command__&&10<e.getPTPRange(this.__pre_point__,i)&&(this.__tmp_undo_command__.finish(),this.history.add(this.__tmp_undo_command__)),(this.__tmp_undo_command__=null)!==this.cut_doodle&&this.cut_doodle.editFinish(),h.type===n.RECT_BLUR?this._finish_for_blur():h.type===n.LIST&&(a.radius.a=h.radius.a,a.radius.b=h.radius.b),void this.paint();if(this.cut_mode)return this.cut_doodle=this.temp_doodle,this.temp_doodle=null,this.cut_doodle.selected=!0,this.has_selected_doodle=!0,this.edit_doodle.attachDoodle(this.cut_doodle),void this.paint();var r=this.temp_doodle;if(null===r){var _=this.style;return this.__draw_point__&&((r=t.create(n.CURVE,{drawer:this,pen_width:_.pen_width,line_type:_.dot_type|_.arrow_type,color:o(_.color,_.pen_opacity),points:[this.__pre_point__]})).initialize(),this.insertDoodle(r)),void this.paint()}r.editFinish();var l=r.type;if(r=this.temp_doodle,l===n.TEXT)r.auto_width=Math.abs(r.points[1].x-r.points[0].x)<30,r.initialize(),this.insertDoodle(r),this.cur_textbox=r,this._select_doodle(r);else if(l===n.CALLOUT)r.initialize(),this.insertDoodle(r),this.cur_textbox=r.child_textbox,this._select_doodle(r);else if(l===n.BEZIER_ARROW)r.initialize(),this.insertDoodle(r),this._select_doodle(r);else if(l===n.IMAGE){var d=r.points;Math.abs(d[0].x-d[1].x)<10&&Math.abs(d[0].x-d[1].x)<10&&r.editPushPoint({x:d[0].x+150,y:d[0].y+150}),r.initialize(),this.insertDoodle(r)}else l!==n.CUT&&(r.initialize(),this.insertDoodle(r),l===n.RECT_BLUR&&this._finish_for_blur());this.temp_doodle=null,this._paintEditLayer(),l===n.TEXT?this.activeTextbox():l===n.CALLOUT?this.activeInnerTextbox():l!==n.CUT&&this.paint()},_adjust_scroll:function(t,i){var e=this.out_container,o=e.scrollLeft,s=e.scrollTop,n=e.offsetWidth,a=e.offsetHeight,h=this.bg_info,r=this.zoom_scale,_=Math.floor((i-30-h.y)*r),l=_-s,d=Math.floor((i+30-h.y)*r),c=d-s,u=Math.floor((t-h.x-30)*r)-30,f=u-o,p=Math.floor((t+30-h.x)*r),g=p-o;l<0?e.scrollTop=Math.max(0,_):a<c&&(e.scrollTop=Math.min(d-a,Math.floor(h.height*r-a))),f<0?e.scrollLeft=Math.max(0,u):n<g&&(e.scrollLeft=Math.min(Math.floor(h.width*r-n),p-n))},_mouse_move:function(i){var e=this.__hover_doodle__;if(null!==e){var s=this.edit_doodle.editMove(i);return e.editMove(s.x,s.y),null!==this.cut_doodle&&this.cut_doodle.editMove(s.x,s.y),this._adjust_scroll(i.x,i.y),void this._paintEditLayer()}if(null===this.temp_doodle){var n=this.style,a=n.brush_type,h=this.__pre_point__;null!==this.cut_doodle&&(this.cut_doodle=null),a===t.Type.TEXT||a===t.Type.LIST||(a===t.Type.IMAGE?this.temp_doodle=t.create(a,{drawer:this,image:this.style.svg_image,points:[h,i]}):(this.temp_doodle=t.create(a,{drawer:this,pen_width:n.pen_width,line_type:n.dot_type|n.arrow_type,color:o(n.color,n.pen_opacity),points:[h,i]}),a===t.Type.RECT_BLUR&&this._prepare_for_blur()))}else this.temp_doodle.editPushPoint(i),this._adjust_scroll(i.x,i.y);this._paintEditLayer()}})}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){t._EditDoodle=function(i){this.base(t.Type.EDITHELPER,{drawer:i,points:[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],color:"rgba(123,123,123,0.5)"}),this.pre_points=e.copyPoints(this.points),this.selected_doodle=null,this.center={x:0,y:0},this.pre_point={x:0,y:0},this.inter_point={x:0,y:0},this.edit_regions.push(new t.TipRegion(this,0,this.points[4])),this.tip_region=this.edit_regions[0],this.tip_region.disabled=!0,this.__tmp_undo_command__=null},t._EditDoodle.prototype={getRegionUndoCommand:function(){return this.__tmp_undo_command__},onRegionEdit:function(t,i){if(0===t){var e=this.editRotateScale(i);this.selected_doodle.editRotateScale(this.center,e.rotate,e.scale),this._set_rotate_point()}},onRegionEditStart:function(t,i){var e=this.selected_doodle;this.__tmp_undo_command__=e.getRotateUndoCommand(),e.editStart(i),this.pre_point.x=i.x,this.pre_point.y=i.y,this.inter_point.x=i.x,this.inter_point.y=i.y},onRegionEditFinish:function(t,i){this.selected_doodle.editFinish(),null!==this.__tmp_undo_command__&&(this.__tmp_undo_command__.finish(),this.drawer.history.add(this.__tmp_undo_command__),this.__tmp_undo_command__=null),this._calc(),this._set_rotate_point()},attachDoodle:function(t){var i=this.points,e=t.boundary;i[0].x=e.left,i[0].y=e.top,i[1].x=e.right,i[1].y=e.top,i[2].x=e.right,i[2].y=e.bottom,i[3].x=e.left,i[3].y=e.bottom,t.setRegionDisabled(!1),this.selected_doodle=t,this._calc(),this._set_rotate_point()},_re_attach_doodle:function(){null!==this.selected_doodle&&this.attachDoodle(this.selected_doodle)},_set_rotate_point:function(){if(null!==this.selected_doodle){var t=this.selected_doodle.getRotatePoint();null!==t?(this.points[4].x=t.x,this.points[4].y=t.y,this.tip_region.disabled=!1):this.tip_region.disabled=!0}},attachNothing:function(){this.selected_doodle=null,this.tip_region.disabled=!0},_calc:function(){var t=this.points;this.center.x=Math.floor((t[0].x+t[2].x)/2),this.center.y=Math.floor((t[0].y+t[2].y)/2)},editStart:function(t){e.setPoints(this.pre_points,this.points),this._calc(),this.pre_point.x=t.x,this.pre_point.y=t.y},editMove:function(t){for(var i={x:t.x-this.pre_point.x,y:t.y-this.pre_point.y},e=0;e<this.points.length;e++)this.points[e].x=this.pre_points[e].x+i.x,this.points[e].y=this.pre_points[e].y+i.y;return i},_editFinish:function(){this._calc(),this.drawer.onChange()},editFinish:function(t){return this._editFinish(),{x:t.x-this.pre_point.x,y:t.y-this.pre_point.y}},editRotateScale:function(t){return this._calcRSValue(t)},_calcRSValue:function(t){var i=t.x-this.center.x,e=t.y-this.center.y,o=this.pre_point.x-this.center.x,s=this.pre_point.y-this.center.y,n=Math.sqrt(i*i+e*e),a=Math.sqrt(o*o+s*s),h=(i*o+e*s)/(n*a),r=Math.acos(h);return Math.abs(h-1)<=1e-7?r=0:Math.abs(1+h)<=1e-7?r=Math.PI:0<i*s-o*e&&(r=2*Math.PI-r),{scale:n/a,rotate:r}}},e.inherit(t._EditDoodle,t._Doodle)}(Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e){i.EventRegion=function(t,i,e){this.doodle=t,this.idx=i,this.is_mouse_in=!1,this.is_changed=!1,this.cursor=e?"cursor_"+e:"cursor_pointer",this.disabled=!0},i.EventRegion.prototype={isPointIn:function(t){return!1},isPointIn_xy:function(t,i){return!1},onMouseIn:function(){this.is_mouse_in=!0},onMouseOut:function(){this.is_mouse_in=!1},onMouseDown:function(t){this.is_changed=!1,this.doodle.onRegionEditStart(this.idx,t)},onMouseMove:function(t){this.doodle.onRegionEdit(this.idx,t),this.is_changed=!0},onMouseUp:function(t){this.doodle.onRegionEditFinish(this.idx,t)},draw:function(t,i){},editDraw:function(t,i,e){this.doodle.draw_region(t,i,e)}},i.CircleRegion=function(t,i,e,o,s){this.base(t,i,s),this.center=e,this.radius=void 0===o?7:o},i.CircleRegion.prototype={isPointIn:function(t){return!this.disabled&&e.getPTPRange(this.center,t)<=this.radius},draw:function(t,i){t.save(),t.strokeStyle="rgba(0,0,0,0.1)",t.lineWidth=1,t.save(),t.shadowColor="rgba(0,0,0,0.25)",t.shadowBlur=4,t.shadowOffsetX=0,t.shadowOffsetY=2,t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!1),t.stroke(),t.closePath(),t.fillStyle="#fff",t.fill(),t.restore();var e=this.center.x-this.radius+2,o=this.center.y-this.radius+2,s=t.createLinearGradient(e,o,e,o+2*(this.radius-2));s.addColorStop(0,"#09f"),s.addColorStop(1,"#07f"),t.fillStyle=s,t.beginPath(),t.arc(this.center.x,this.center.y,this.radius-2,0,2*Math.PI,!1),t.closePath(),t.fill(),t.restore()}},e.inherit(i.CircleRegion,i.EventRegion),i.TipRegion=function(t,i,e){this.base(t,i,e,5,"rotation")},i.TipRegion.prototype={isPointIn:function(t){return!this.disabled&&e.getPTPRange(this.center,t)<=this.radius},isPointIn_xy:function(t,i){return!this.disabled&&e.getPTPRange_xy(this.center.x,this.center.y,t,i)<=this.radius},draw:function(t,i){this.disabled||(t.save(),t.strokeStyle="rgba(0,0,0,0.2)",t.lineWidth=2,t.save(),t.shadowColor="rgba(0,0,0,0.15)",t.shadowBlur=3,t.shadowOffsetX=0,t.shadowOffsetY=1,t.beginPath(),t.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!1),t.stroke(),t.closePath(),t.fillStyle="#fff",t.fill(),t.restore(),t.fillStyle="#080",t.beginPath(),t.arc(this.center.x,this.center.y,this.radius-1,0,2*Math.PI,!1),t.closePath(),t.fill(),t.restore())}},e.inherit(i.TipRegion,i.CircleRegion)}(Diigo.Text,Diigo.Doodle,Diigo.$),function(t,i){var e=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],o=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];i.stackBlurCanvasRGBA=function(t,i,s,n,a,h){var r=t.getImageData(i,s,n,a);!function(t,i,s,n){var a,h,r,_,l,d,c,u,f,p,g,x,y,m,v,w,b,D,T,M,C,E,P,R,S=t.data,L=n+n+1,A=i-1,I=s-1,z=n+1,k=z*(z+1)/2,B={r:0,g:0,b:0,a:0,next:null},U=B;for(r=1;r<L;r++)if(U=U.next={r:0,g:0,b:0,a:0,next:null},r==z)var O=U;U.next=B;var F=null,N=null;c=d=0;var W=e[n],H=o[n];for(h=0;h<s;h++){for(w=b=D=T=u=f=p=g=0,x=z*(M=S[d]),y=z*(C=S[d+1]),m=z*(E=S[d+2]),v=z*(P=S[d+3]),u+=k*M,f+=k*C,p+=k*E,g+=k*P,U=B,r=0;r<z;r++)U.r=M,U.g=C,U.b=E,U.a=P,U=U.next;for(r=1;r<z;r++)_=d+((A<r?A:r)<<2),u+=(U.r=M=S[_])*(R=z-r),f+=(U.g=C=S[_+1])*R,p+=(U.b=E=S[_+2])*R,g+=(U.a=P=S[_+3])*R,w+=M,b+=C,D+=E,T+=P,U=U.next;for(F=B,N=O,a=0;a<i;a++)S[d+3]=P=g*W>>H,0!=P?(P=255/P,S[d]=(u*W>>H)*P,S[d+1]=(f*W>>H)*P,S[d+2]=(p*W>>H)*P):S[d]=S[d+1]=S[d+2]=0,u-=x,f-=y,p-=m,g-=v,x-=F.r,y-=F.g,m-=F.b,v-=F.a,_=c+((_=a+n+1)<A?_:A)<<2,u+=w+=F.r=S[_],f+=b+=F.g=S[_+1],p+=D+=F.b=S[_+2],g+=T+=F.a=S[_+3],F=F.next,x+=M=N.r,y+=C=N.g,m+=E=N.b,v+=P=N.a,w-=M,b-=C,D-=E,T-=P,N=N.next,d+=4;c+=i}for(a=0;a<i;a++){for(b=D=T=w=f=p=g=u=0,x=z*(M=S[d=a<<2]),y=z*(C=S[d+1]),m=z*(E=S[d+2]),v=z*(P=S[d+3]),u+=k*M,f+=k*C,p+=k*E,g+=k*P,U=B,r=0;r<z;r++)U.r=M,U.g=C,U.b=E,U.a=P,U=U.next;for(l=i,r=1;r<=n;r++)d=l+a<<2,u+=(U.r=M=S[d])*(R=z-r),f+=(U.g=C=S[d+1])*R,p+=(U.b=E=S[d+2])*R,g+=(U.a=P=S[d+3])*R,w+=M,b+=C,D+=E,T+=P,U=U.next,r<I&&(l+=i);for(d=a,F=B,N=O,h=0;h<s;h++)S[3+(_=d<<2)]=P=g*W>>H,0<P?(P=255/P,S[_]=(u*W>>H)*P,S[_+1]=(f*W>>H)*P,S[_+2]=(p*W>>H)*P):S[_]=S[_+1]=S[_+2]=0,u-=x,f-=y,p-=m,g-=v,x-=F.r,y-=F.g,m-=F.b,v-=F.a,_=a+((_=h+z)<I?_:I)*i<<2,u+=w+=F.r=S[_],f+=b+=F.g=S[_+1],p+=D+=F.b=S[_+2],g+=T+=F.a=S[_+3],F=F.next,x+=M=N.r,y+=C=N.g,m+=E=N.b,v+=P=N.a,w-=M,b-=C,D-=E,T-=P,N=N.next,d+=i}}(r,n,a,void 0===h?7:h),t.putImageData(r,i,s)}}(Diigo.Doodle,Diigo.$),function(t,i,e,o){t._Editor=function(i){this.parent=i,this.history=i.history,this.auto_width=!1,this.textarea=i.textarea,this.textarea_out=i.textarea_out,this.floated_textbox=null,this.RTL=i.RTL,this.cur_page=null,this.pages=[],this.render=new t._Render(this),this.initEvent(),this.focused=!1,this.saved_info={cur_page:null,width:0,height:0,scale:1}},t._Editor.prototype={onChange:function(){},paint:function(){this.render.paint()},_paint:function(){this.render._paint()},getPageByIdx:function(t){return this.pages[t]},setBoxAutoWidth:function(t){this.auto_width=t},setBoxSize_scale:function(t,i,e){var o=Math.floor(t*e),s=Math.floor(i*e);this.textarea.style.width=o/this.parent.dpr+"px",this.textarea.style.height=s/this.parent.dpr+"px",this.render.width=t,this.render.height=i,this.render.scale=e},save_state:function(){var t=this.saved_info;t.scale=this.render.scale,t.width=this.render.width,t.height=this.render.height,t.cur_page=this.cur_page},set_drawtext_size:function(t,i,e){this.render.width=t,this.render.height=i,this.render.scale=e},restore_state:function(){var t=this.saved_info;this.render.scale=t.scale,this.render.width=t.width,this.render.height=t.height,this.cur_page=t.cur_page,this.render.page=t.cur_page;var i=Math.floor(t.width*t.scale),e=Math.floor(t.height*t.scale);this.textarea.style.width=i+"px",this.textarea.style.height=e+"px"},getPageHeight:function(t){return this.pages[t].page_height},setBoxMatrix:function(t){var i="matrix("+t[0]+","+t[3]+","+t[1]+","+t[4]+","+t[2]/this.parent.dpr+","+t[5]/this.parent.dpr+")";this.textarea.style.webkitTransform=i},setBoxPosition:function(t,i,e){this.textarea_out.style.left=t+"px",this.textarea_out.style.top=i+"px",this.textarea.style.webkitTransform="rotate("+Math.round(180*e/Math.PI)+"deg)"},createPage:function(i){var e=new t._Page(this,i);return this.pages.push(e),this.pages.length-1},setCurPage:function(t,i){this.cur_page=this.pages[t],this.render.page=this.cur_page,this.render.m_auto_width=!!i;var e=this.cur_page.style.getScaleFontForTextArea(this.parent.zoom_scale);this.textarea.style.font=e,this.textarea.style.lineHeight=o.getFontInfo(e).height+"px",this.textarea.style.color=this.cur_page.style.color,this.textarea.value=this.cur_page.text},_setCurPage:function(t){this.cur_page=this.pages[t],this.render.page=this.cur_page},_setCurPage_saved:function(t){var i=this.pages.indexOf(this.cur_page);return this._setCurPage(t),i},focus:function(){!1===this.focused&&(this.focused=!0,this.textarea.focus())},blur:function(){this.focused&&(this.focused=!1,this.textarea.blur())},clear:function(){this.cur_page.reset(),this.select_doodle=null,this._setCaret({index:-1,para:0,para_at:-1,left:0,top:0}),this.history.clear()},show:function(){this.textarea.style.display="block"},hide:function(){this.textarea.style.display="none"}}}(Diigo.Text,Diigo.Doodle,Diigo.UndoRedo,Diigo.$),function(t,i,e,o,s){s.extend(t._Editor.prototype,{_text_handler:function(){this.floated_textbox.onTextInput(this.textarea.value)},_keypress_handler:function(){this.floated_textbox.onTextPress()},initEvent:function(){s.addEvent(this.textarea,"input",s.createDelegate(this,this._text_handler)),s.addEvent(this.textarea,"keypress",s.createDelegate(this,this._keypress_handler))}})}(Diigo.Text,Diigo.Doodle,Diigo.Data,Diigo.UndoRedo,Diigo.$),function(t,i){t._Paragraph=function(i,e,o,s,n,a,h){this.index=i,this.length=e,this.line_start=o,this.line_cross=s,this.lines=h||[new t._Line],this.rtl=!!n,this.align=a||t._Paragraph.Align.LEFT},t._Paragraph.Align={LEFT:0,RIGHT:1,MIDDLE:2},t._Line=function(t,i,e){this.end_index=t||-1,this.unti_dir=i||[],this.width=e||0},t._Element=function(t){this.value=t,this.width=0,this.visible=!0},t._Page=function(t,e){this.editor=t,this.style=e,this.text="",this.ele_array=[],this.para_number=0,this.para_info=[],this.line_number=0,this.page_height=0;var o=i.getFontInfo(e.font);this.line_height=o.height,this.baseline_offset=o.baseline_offset,this._init()},t._Page.prototype={resetFont:function(){var t=i.getFontInfo(this.style.font);this.line_height=t.height,this.baseline_offset=t.baseline_offset},_init:function(){this.para_number=1,this.para_info=[new t._Paragraph(-1,0,0,1,!1,t._Paragraph.Align.LEFT)],this.line_number=1,this.page_height=this.line_number*this.line_height,this.text="",this.ele_array.length=0},reset:function(){this._init()},initParagraph:function(){var i,e=-1,o=0,s=new t._Paragraph(e,0,o,1);for(this.ele_array.length=this.text.length,i=0;i<this.text.length;i++)this.ele_array[i]=new t._Element(this.text[i]);for(this.para_number=1,this.para_info=[],this.line_number=0,this.para_info.push(s),i=0;i<this.ele_array.length;i++)"\n"===this.ele_array[i].value&&(s.length=i-e-1,s.line_cross=this._measureParagraph(s),o+=s.line_cross,this.line_number+=s.line_cross,e=i,s=new t._Paragraph(e,0,o,1),this.para_info.push(s),this.para_number++);s.length=this.ele_array.length-1-e,s.line_cross=this._measureParagraph(s),this.line_number+=s.line_cross,this.page_height=this.line_number*this.line_height},_measureParagraph:function(t){return t.rtl=this._getParaRTL(t),this.editor.render._measure(t,this.style)},_getParaRTL:function(i){var e=!1,o=0;if(0<i.length)for(var s=i.index+1;s<i.index+1+i.length;s++)if(0<=(o=this.text.charCodeAt(s))&&!t.Char.isBiaoDian(o)&&!t.Char.isDigit(o)){e=!0;break}return!!e&&t.Char.isRTL(o)}}}(Diigo.Text,Diigo.$),function(t){t._Style=function(t){t=t||{},this.color=t.color?t.color:"#000000",this.background=!!t.background&&t.background,this.underline=!!t.underline&&t.underline,this.through=!!t.through&&t.through,this.bold=!!t.bold&&t.bold,this.italic=!!t.italic&&t.italic,this.font_name=t.font_name?t.font_name:"Arial",this.font_size=t.font_size?t.font_size:16,this.font=this._getFont(),this.textBackground=t.textBackground},t._Style.prototype={setFontName:function(t){this.font_name=t,this.font=this._getFont()},setFontSize:function(t){this.font_size=t,this.font=this._getFont()},setItalic:function(t){this.italic=t,this.font=this._getFont()},setThrough:function(t){this.through=t},setScale:function(t){this.scale=t,this.font=this._getFont()},setBold:function(t){this.bold=t,this.font=this._getFont()},setTextBackground:function(t){this.textBackground=t},setStyle:function(t){null!=t.bold&&(this.bold=t.bold),null!=t.color&&(this.color=t.color),null!=t.background&&(this.background=t.background),null!=t.bg_invert&&(this.bg_invert=t.bg_invert),null!=t.underline&&(this.underline=t.underline),null!=t.through&&(this.through=t.through),null!=t.italic&&(this.italic=t.italic),null!=t.font_name&&(this.font_name=t.font_name),null!=t.font_size&&(this.font_size=t.font_size),this.textBackground=t.textBackground,this.font=this._getFont()},clone:function(){return new t._Style(this)},_getFont:function(){return(this.bold?"bold ":"")+(this.italic?"italic ":"")+this.font_size+"px "+this.font_name},getScaleFont:function(t){return(this.bold?"bold ":"")+(this.italic?"italic ":"")+Math.floor(this.font_size*t)+"px "+this.font_name},getScaleFontForTextArea:function(t){return(this.bold?"bold ":"")+(this.italic?"italic ":"")+Math.floor(this.font_size*t/window.devicePixelRatio)+"px "+this.font_name}}}(Diigo.Text),function(t,i){t._Render=function(t){this.editor=t,this.page=null,this.width=0,this.height=0,this.scale=1,this.baseline_offset=0,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d")},t._Render.prototype={_paintLine:function(t,i,e,o,s,n,a,h){var r=this.editor.cur_page.text.substr(e+t,i-t+1);h.textBackground||(this.ctx.shadowColor="rgba(0,0,0,.1)",this.ctx.shadowBlur=1,this.ctx.shadowOffsetX=1,this.ctx.shadowOffsetY=1),this.ctx.fillText(r,a+6,n)},_paintContent:function(i){var e=this.editor,o=this.scale,s=e.cur_page.line_height,n=e.cur_page.line_height*o,a=this.page.para_info,h=0,r=0/o,_=0,l=0,d=0,c=this.height*o+n;d=r<=0?(l=-r+s,n-(_=0)):(l=((_=Math.floor(r/s))+1)*s-r,(_+1)*n-0);for(var u=0;u<a.length&&(h+=a[u].lines.length)<=_;)u++;if(!(u>=a.length)){var f=_-(h-a[u].lines.length);t:for(;u<a.length;u++){var p=a[u],g=p.lines,x=0,y=t._Paragraph.Align;0<f&&(x=g[f-1].end_index+1);for(var m=f;m<g.length;m++){var v=0;switch(p.align){case y.LEFT:v=0;break;case y.MIDDLE:v=Math.round((this.width-g[m].width)/2);break;case y.RIGHT:v=this.width-g[m].width}if(this._paintLine(x,g[m].end_index,p.index+1,g[m].unti_dir,p.rtl,l-e.cur_page.baseline_offset,v,i),x=g[m].end_index+1,l+=s,c<=(d+=n))break t}f=0}}},_calc_text_color:function(t){return"#fff"===t||"rgba(255,255,255,1)"===t?"black":"#fff"},paintToContext:function(t,i){var e=this.ctx,o=this.scale;this.ctx=t,this.ctx.save(),this.ctx.scale(o,o),this.ctx.font=i.font,i.textBackground?this.ctx.fillStyle=this._calc_text_color(i.color):this.ctx.fillStyle=i.color,""!==this.page.text.trim()&&this._paintContent(i),this.ctx.restore(),this.ctx=e}}}(Diigo.Text,Diigo.$),function(t,i){t.Char={isRTL:function(t){return 1536<=t&&t<=1791},isBiaoDian:function(t){return 32<=t&&t<=47||58<=t&&t<=64||91<=t&&t<=96||123<=t&&t<=126},isDigit:function(t){return 48<=t&&t<=57},isIdeographic:function(t,i){if(11904<=t&&t<=12287)return!0;if(12288===t)return!0;if(12352<=t&&t<=12447){if(!i)switch(t){case 12353:case 12355:case 12357:case 12359:case 12361:case 12387:case 12419:case 12421:case 12423:case 12430:case 12437:case 12438:case 12443:case 12444:case 12445:case 12446:return!1}return!0}if(12448<=t&&t<=12543){if(!i)switch(t){case 12448:case 12449:case 12451:case 12453:case 12455:case 12457:case 12483:case 12515:case 12517:case 12519:case 12526:case 12533:case 12534:case 12539:case 12540:case 12541:case 12542:return!1}return!0}return 13312<=t&&t<=19893||19968<=t&&t<=40891||63744<=t&&t<=64217||40960<=t&&t<=42127||42128<=t&&t<=42191||65122<=t&&t<=65126||65296<=t&&t<=65305}},i.extend(t._Render.prototype,{_getDirLength:function(i,e,o,s){for(var n=!1,a=1,h=e+1,r=0;h<o;){var _=i[h].value.charCodeAt(h);if(s?t.Char.isRTL(_):0<_&&!t.Char.isRTL(_)&&!t.Char.isBiaoDian(_))n&&(a+=r,n=!1,r=0),a++;else{if(!(_<0||t.Char.isBiaoDian(_)))break;r++,n=!0}h++}return a},_getCode:function(t){return t.value.charCodeAt(0)},_measureStrElement:function(t){return this.ctx.measureText(t).width},_measureElement:function(t){return this.ctx.measureText(t.value).width},_measure:function(i,e){return this.ctx.font=e.font,i.lines=[new t._Line(-1,[],0)],this._doMeasure(i)},_m_LTR:function(i,e,o,s,n,a,h,r){for(var _=s-1,l=!!i,d=0,c=s,u=i?s+this._getDirLength(o,s,r,!1):r,f=i?e:this.width-e,p=i?s:-1;c<u;){var g=o[c],x=this._getCode(g),y=c===s?null:o[c-1],m=(null===y||this._getCode(y),c+1<r?o[c+1]:null),v=null===m?-1:this._getCode(m);if(!i&&t.Char.isRTL(x)){u=c;break}if(0<=x&&0===g.width&&(g.width=this._measureElement(g)),(d+=g.width)<f)(x<0||32===x||9===x||!(44!==x&&46!==x&&58!==x&&59!==x||c!==h&&t.Char.isDigit(this._getCode(o[c-1]))||null!==m&&t.Char.isDigit(v))||!(45!==x&&47!==x||null!==m&&t.Char.isDigit(v))||11904<=x&&t.Char.isIdeographic(x,!0)&&null!==m&&t.Char.isIdeographic(v,!1))&&(l=!1,_=c);else{if(32!==x){(s<=_||l)&&(c=_+1);var w=n-a.line_start;if(!l&&i){for(var b={index:p-h,length:c-p,width:0},D=p;D<c;D++)b.width+=o[D].width;a.lines[w].unti_dir.push(b)}a.lines[w].end_index=c-1-h,a.lines.push(new t._Line),d=0,p=c,e=i?this.width:0,f=this.width,d=0,_=s-1,n++,l=!1;continue}g.visible=!1,_=c}c++}return i&&a.lines[n-a.line_start].unti_dir.push({index:p-h,length:u-p,width:d}),{left:i?e-d:e+d,line_at:n,end_index:u}},_calc_line_width:function(t,i,e){for(var o=0,s=i;s<=e;s++)t[s].visible&&(o+=t[s].width);return o},_m_RTL:function(i,e,o,s,n,a,h,r){for(var _=s-1,l=!!i,d=0,c=s,u=i?this.width-e:e,f=i?s+this._getDirLength(o,s,r,!0):r,p=i?s:-1,g=c,x=0,y="";c<f;){var m=o[c],v=c+1<r?o[c+1]:null,w=this._getCode(m);if(!i&&0<=w&&!t.Char.isRTL(w)&&!t.Char.isBiaoDian(w)){f=c;break}if(d+(x=0<w?(y+=m.value,this._measureStrElement(m,y)):m.width)<u){if(w<1536&&(l=!1,_=c),w<1536||null===v||!t.Char.isRTL(this._getCode(v))){if(0<w)for(var b=g;b<=c;b++)o[b].width=x/(c-g+1);d+=x,y="",g=c+1}c++}else{(s<_||l)&&(c=_+1);var D=n-a.line_start;if(!l&&i){for(var T={index:p-h,length:c-p,width:0},M=p;M<c;M++)T.width+=o[M].width;a.lines[D].unti_dir.push(T)}for(a.lines[D].end_index=c-1-h,a.lines.push(new t._Line),p=c,b=g;b<=c;b++)o[b].width=x/(c-g+1);y="",g=c,e=i?0:this.width,u=this.width,d=0,_=s-1,n++,l=!1}}return i&&a.lines[n-a.line_start].unti_dir.push({index:p-h,length:f-p,width:d}),{left:i?e+d:e-d,line_at:n,end_index:f}},_doMeasure:function(t){for(var i=t.rtl,e=t.index+1,o=e+t.length,s=t.line_start,n=this.page.ele_array,a=i?this.width:0,h=e,r=null;h<o;)s=(r=i?this._m_RTL(!1===t.rtl,a,n,h,s,t,e,o):this._m_LTR(!0===t.rtl,a,n,h,s,t,e,o)).line_at,a=r.left,h=r.end_index,i=!i;for(t.lines[s-t.line_start].end_index=t.length-1,h=0;h<t.lines.length;h++){var _=this._calc_line_width(n,t.index+1+(0===h?0:t.lines[h-1].end_index),t.index+1+t.lines[h].end_index);t.lines[h].width=_}return s-t.line_start+1}})}(Diigo.Text,Diigo.$);